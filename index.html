<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VegeOrder Pro">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0891b2">
    <meta name="msapplication-navbutton-color" content="#0891b2">
    
    <title>VegeOrder Pro - Enhanced Malaysian Vegetable Manager with Quotations</title>
    
    <!-- Mobile App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMxMGI5ODEiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgZmlsbD0id2hpdGUiPgo8dGV4dCB4PSI1MCIgeT0iNjUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI2MCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+luTwvdGV4dD4KPC9zdmc+Cjwvc3ZnPg==">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzEwYjk4MSIvPgo8dGV4dCB4PSIxNiIgeT0iMjIiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPvCfpbk8L3RleHQ+Cjwvc3ZnPg==">
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 50%, #164e63 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            font-size: 16px;
            line-height: 1.5;
        }
        
        /* Mobile Container */
        .app-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 50%, #164e63 100%);
        }
        
        /* Status Bar */
        .status-bar {
            height: env(safe-area-inset-top, 44px);
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 14px;
            font-weight: 600;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            padding-top: env(safe-area-inset-top, 0);
            min-height: 44px;
        }
        
        .status-bar .time {
            color: white;
        }
        
        .status-bar .indicators {
            display: flex;
            align-items: center;
            gap: 4px;
            color: white;
        }
        
        /* Header */
        .app-header {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(30px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: env(safe-area-inset-top, 44px);
            left: 0;
            right: 0;
            z-index: 90;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #22d3ee, #06b6d4);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .app-title h1 {
            font-size: 20px;
            font-weight: 700;
            line-height: 1;
            letter-spacing: -0.5px;
        }
        
        .app-title p {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .connection-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            margin-right: 8px;
        }
        
        .connection-status.offline {
            background: #ef4444;
        }
        
        .header-stats {
            text-align: right;
            font-size: 12px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: calc(env(safe-area-inset-top, 44px) + 80px) 20px calc(env(safe-area-inset-bottom, 20px) + 100px);
            -webkit-overflow-scrolling: touch;
            position: relative;
            scroll-behavior: smooth;
        }
        
        /* Custom Scrollbar */
        .main-content::-webkit-scrollbar {
            width: 3px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        
        /* Cards */
        .card {
            background: rgba(255,255,255,0.18);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin: 16px 0;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .card:active {
            transform: scale(0.98);
        }
        
        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.18);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 16px 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-card:active {
            transform: scale(0.95);
        }
        
        .stat-label {
            font-size: 10px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            line-height: 1;
        }
        
        .stat-trend {
            font-size: 12px;
            margin-top: 4px;
            font-weight: 600;
        }
        
        .trend-up { color: #22c55e; }
        .trend-down { color: #ef4444; }
        .trend-neutral { color: rgba(255,255,255,0.7); }
        
        /* Enhanced Analytics Card */
        .analytics-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1));
            backdrop-filter: blur(30px);
            border-radius: 24px;
            padding: 24px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .analytics-title {
            font-size: 20px;
            font-weight: 800;
            color: white;
        }
        
        .analytics-period {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 12px;
        }
        
        /* Chart Container */
        .chart-container {
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            margin: 16px 0;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .chart-placeholder {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            text-align: center;
        }
        
        /* Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        
        .insight-card {
            background: rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }
        
        .insight-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .insight-label {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Enhanced Search */
        .enhanced-search {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 18px 20px 18px 56px;
            border-radius: 16px;
            border: none;
            background: rgba(255,255,255,0.25);
            color: white;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .search-input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .search-input:focus {
            outline: none;
            background: rgba(255,255,255,0.35);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }
        
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: rgba(255,255,255,0.7);
            pointer-events: none;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .search-result-item {
            padding: 16px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            color: #1f2937;
        }
        
        .search-result-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-highlight {
            background: #fbbf24;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        /* Action Buttons */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .action-btn {
            padding: 20px;
            border-radius: 20px;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: 100px;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn:active {
            transform: scale(0.96);
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        }
        
        .action-btn.secondary {
            background: linear-gradient(135deg, #0891b2 0%, #164e63 100%);
        }
        
        .action-btn.accent {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        
        .action-btn.quotation {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
        }
        
        .action-btn .icon {
            font-size: 28px;
        }
        
        /* Enhanced Forms */
        .form-input {
            width: 100%;
            padding: 18px 20px;
            border-radius: 16px;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.95);
            color: #1f2937;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }
        
        .form-input::placeholder {
            color: #6b7280;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #0891b2;
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }
        
        .form-input.error {
            border-color: #ef4444;
            background: rgba(254, 242, 242, 0.95);
        }
        
        .form-error {
            color: #ef4444;
            font-size: 14px;
            margin-top: -12px;
            margin-bottom: 16px;
            padding-left: 20px;
            font-weight: 600;
        }
        
        /* Enhanced Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            border-radius: 16px;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 52px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:active {
            transform: scale(0.96);
        }
        
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .btn-gray { background: linear-gradient(135deg, #6b7280, #4b5563); }
        
        /* Enhanced Item Cards */
        .item-card {
            background: rgba(255,255,255,0.18);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .item-card:active {
            transform: scale(0.98);
            background: rgba(255,255,255,0.25);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .item-info h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.2;
        }
        
        .item-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }
        
        .item-meta .icon {
            font-size: 14px;
            width: 16px;
        }
        
        /* Icon Buttons */
        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .icon-btn:active {
            transform: scale(0.9);
        }
        
        .icon-btn.primary {
            background: rgba(59, 130, 246, 0.8);
        }
        
        .icon-btn.danger {
            background: rgba(239, 68, 68, 0.8);
        }
        
        .icon-btn.success {
            background: rgba(16, 185, 129, 0.8);
        }
        
        .icon-btn.warning {
            background: rgba(245, 158, 11, 0.8);
        }
        
        .icon-btn.purple {
            background: rgba(124, 58, 237, 0.8);
        }
        
        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(30px);
            border-top: 1px solid rgba(255,255,255,0.2);
            padding: 12px 20px calc(env(safe-area-inset-bottom, 20px) + 12px);
            z-index: 100;
        }
        
        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 6px;
            border-radius: 16px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            min-width: 50px;
            position: relative;
        }
        
        .nav-item.active {
            color: white;
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        .nav-item .icon {
            font-size: 20px;
        }
        
        .nav-item .badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 700;
            min-width: 16px;
            text-align: center;
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: flex-end;
            z-index: 200;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(30px);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            color: #1f2937;
            animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(30px);
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            border: none;
            background: #f3f4f6;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
        }
        
        .close-btn:active {
            transform: scale(0.9);
            background: #e5e7eb;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: calc(env(safe-area-inset-top, 44px) + 80px);
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px 20px;
            border-radius: 16px;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
            z-index: 250;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        /* Low Stock Alert */
        .low-stock-alert {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .low-stock-alert .icon {
            font-size: 24px;
        }
        
        .low-stock-content h4 {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .low-stock-content p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Category Filters */
        .category-filters {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        .category-btn {
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.15);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: fit-content;
        }
        
        .category-btn.active {
            background: rgba(255,255,255,0.3);
            color: white;
            transform: scale(1.05);
        }
        
        .category-btn:active {
            transform: scale(0.95);
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.7);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }
        
        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Quotation Specific Styles */
        .quotation-card {
            background: rgba(255,255,255,0.18);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .quotation-card:active {
            transform: scale(0.98);
            background: rgba(255,255,255,0.25);
        }
        
        .quotation-status {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: rgba(251, 191, 36, 0.8);
            color: #92400e;
        }
        
        .status-sent {
            background: rgba(59, 130, 246, 0.8);
            color: #1e40af;
        }
        
        .status-accepted {
            background: rgba(16, 185, 129, 0.8);
            color: #065f46;
        }
        
        .status-rejected {
            background: rgba(239, 68, 68, 0.8);
            color: #991b1b;
        }
        
        .status-expired {
            background: rgba(107, 114, 128, 0.8);
            color: #374151;
        }
        
        .quotation-summary {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quotation-total {
            font-size: 20px;
            font-weight: 700;
            color: #22d3ee;
        }
        
        .quotation-validity {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        
        /* Quotation Form Styles */
        .quotation-item {
            background: #f9fafb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .quotation-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .quotation-item-name {
            font-weight: 700;
            color: #1f2937;
            font-size: 16px;
        }
        
        .quotation-item-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .quotation-item-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            align-items: center;
        }
        
        .quotation-item-total {
            font-weight: 700;
            color: #10b981;
            font-size: 16px;
            text-align: right;
            grid-column: span 3;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Share Buttons for Quotations */
        .share-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 16px 0;
        }
        
        .share-btn {
            padding: 14px 16px;
            border-radius: 14px;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .share-btn:active {
            transform: scale(0.96);
        }
        
        .share-btn.whatsapp {
            background: linear-gradient(135deg, #25d366, #1db954);
        }
        
        .share-btn.email {
            background: linear-gradient(135deg, #ea4335, #d33b2c);
        }
        
        .share-btn.pdf {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .view { padding-top: 20px; }
        
        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-card {
                padding: 12px 8px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-item {
                font-size: 9px;
                padding: 10px 4px;
            }
            
            .nav-item .icon {
                font-size: 18px;
            }
        }
        
        /* Dark mode status bar for iOS */
        @media (prefers-color-scheme: dark) {
            .status-bar {
                background: rgba(0,0,0,0.5);
            }
        }
        
        /* Performance optimizations */
        .card, .item-card, .modal-content, .quotation-card {
            will-change: transform;
            transform: translateZ(0);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="time" id="status-time">9:41</div>
            <div class="indicators">
                <span>üì∂</span>
                <span>üì±</span>
                <span>üîã</span>
            </div>
        </div>
        
        <!-- Header -->
        <div class="app-header">
            <div class="header-left">
                <div class="app-icon">ü•¨</div>
                <div class="app-title">
                    <h1>VegeOrder Pro</h1>
                    <p>Enhanced Malaysian Vegetable Manager</p>
                </div>
            </div>
            <div class="header-right">
                <div class="connection-status" id="connection-status"></div>
                <div class="header-stats">
                    <p id="current-date">Today</p>
                    <p id="daily-sales">RM 0.00</p>
                </div>
                <button class="icon-btn" onclick="showView('settings')" title="Settings">
                    ‚öôÔ∏è
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view">
                <!-- Enhanced Stats -->
                <div class="stats-grid">
                    <div class="stat-card" onclick="showView('customers')">
                        <div class="stat-label">Customers</div>
                        <div class="stat-value" id="customers-count">0</div>
                        <div class="stat-trend trend-up" id="customers-trend">+12%</div>
                    </div>
                    <div class="stat-card" onclick="showView('products')">
                        <div class="stat-label">Products</div>
                        <div class="stat-value" id="products-count">0</div>
                        <div class="stat-trend trend-neutral" id="products-trend">28 types</div>
                    </div>
                    <div class="stat-card" onclick="showView('orders')">
                        <div class="stat-label">Orders</div>
                        <div class="stat-value" id="orders-count">0</div>
                        <div class="stat-trend trend-up" id="orders-trend">+8%</div>
                    </div>
                    <div class="stat-card" onclick="showView('quotations')">
                        <div class="stat-label">Quotes</div>
                        <div class="stat-value" id="quotations-count">0</div>
                        <div class="stat-trend trend-up" id="quotations-trend">+5%</div>
                    </div>
                </div>

                <!-- Low Stock Alerts -->
                <div id="low-stock-alerts"></div>

                <!-- Analytics Card -->
                <div class="analytics-card">
                    <div class="analytics-header">
                        <div class="analytics-title">üìä Sales Analytics</div>
                        <div class="analytics-period">Last 7 Days</div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-placeholder">
                            üìà Sales trend visualization<br>
                            <small>Tap to view detailed analytics</small>
                        </div>
                    </div>
                    
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-value" id="avg-order-value">RM 0</div>
                            <div class="insight-label">Avg Order</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-value" id="top-product">-</div>
                            <div class="insight-label">Top Product</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-value" id="growth-rate">0%</div>
                            <div class="insight-label">Growth</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-value" id="total-customers">0</div>
                            <div class="insight-label">Active Customers</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h3 style="font-weight: 700; margin-bottom: 16px; font-size: 18px;">‚ö° Quick Actions</h3>
                    <div class="actions-grid">
                        <button class="action-btn quotation" onclick="openQuotationForm()">
                            <span class="icon">üìã</span>
                            <span style="font-weight: 700;">New Quote</span>
                        </button>
                        <button class="action-btn primary" onclick="openOrderForm()">
                            <span class="icon">‚ûï</span>
                            <span style="font-weight: 700;">New Order</span>
                        </button>
                        <button class="action-btn secondary" onclick="showView('quotations')">
                            <span class="icon">üìÑ</span>
                            <span style="font-weight: 700;">View Quotes</span>
                        </button>
                        <button class="action-btn accent" onclick="openInventoryManager()">
                            <span class="icon">üì¶</span>
                            <span style="font-weight: 700;">Inventory</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-weight: 700; font-size: 18px;">üìã Recent Activity</h3>
                        <button style="background: none; border: none; color: rgba(255,255,255,0.8); font-size: 14px; cursor: pointer; font-weight: 600;" onclick="showView('quotations')">View All</button>
                    </div>
                    <div id="recent-activity"></div>
                </div>
            </div>

            <!-- Customers View -->
            <div id="customers-view" class="view hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; font-weight: 700;">üë• Customers</h2>
                    <button class="icon-btn success" onclick="openCustomerForm()">
                        <span>‚ûï</span>
                    </button>
                </div>

                <div class="enhanced-search">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search customers..." id="customer-search" oninput="handleCustomerSearch(this.value)">
                    <div class="search-results hidden" id="customer-search-results"></div>
                </div>

                <div id="customers-list"></div>
            </div>

            <!-- Products View -->
            <div id="products-view" class="view hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; font-weight: 700;">ü•¨ Vegetables</h2>
                    <button class="icon-btn success" onclick="openProductForm()">
                        <span>‚ûï</span>
                    </button>
                </div>

                <div class="enhanced-search">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search vegetables..." id="product-search" oninput="handleProductSearch(this.value)">
                    <div class="search-results hidden" id="product-search-results"></div>
                </div>

                <div class="category-filters" id="category-filters"></div>

                <div id="products-list"></div>
            </div>

            <!-- Orders View -->
            <div id="orders-view" class="view hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; font-weight: 700;">üõí Orders</h2>
                    <button class="icon-btn primary" onclick="openOrderForm()">
                        <span>‚ûï</span>
                    </button>
                </div>

                <input type="date" class="form-input" id="order-date" style="margin-bottom: 16px; color: #1f2937;">
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px;">
                    <button class="category-btn active" data-filter="all">All</button>
                    <button class="category-btn" data-filter="pending">Pending</button>
                    <button class="category-btn" data-filter="completed">Completed</button>
                </div>

                <div id="orders-list"></div>
            </div>

            <!-- Quotations View -->
            <div id="quotations-view" class="view hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; font-weight: 700;">üìã Quotations</h2>
                    <button class="icon-btn purple" onclick="openQuotationForm()">
                        <span>‚ûï</span>
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 20px;">
                    <button class="category-btn active" data-filter="all" onclick="filterQuotations('all')">All</button>
                    <button class="category-btn" data-filter="pending" onclick="filterQuotations('pending')">Pending</button>
                    <button class="category-btn" data-filter="sent" onclick="filterQuotations('sent')">Sent</button>
                    <button class="category-btn" data-filter="accepted" onclick="filterQuotations('accepted')">Accepted</button>
                </div>

                <div id="quotations-list"></div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; font-weight: 700;">‚öôÔ∏è Settings</h2>
                    <button class="icon-btn" onclick="showView('dashboard')">
                        <span>‚Üê</span>
                    </button>
                </div>

                <div class="card">
                    <h3 style="font-weight: 700; margin-bottom: 16px;">üè¢ Company Information</h3>
                    <form id="company-form">
                        <input type="text" class="form-input" placeholder="Company Name *" id="company-name" required>
                        <input type="text" class="form-input" placeholder="Business Tagline" id="company-tagline">
                        <input type="tel" class="form-input" placeholder="Phone Number *" id="company-phone" required>
                        <input type="email" class="form-input" placeholder="Email Address *" id="company-email" required>
                        <input type="text" class="form-input" placeholder="Website (optional)" id="company-website">
                        <textarea class="form-input" placeholder="Business Address *" id="company-address" rows="3" style="resize: none; min-height: 80px;" required></textarea>
                        
                        <button type="submit" class="btn btn-success" style="width: 100%;">
                            üíæ Save Company Settings
                        </button>
                    </form>
                </div>

                <div class="card">
                    <h3 style="font-weight: 700; margin-bottom: 16px;">üìã Quotation Settings</h3>
                    <form id="quotation-settings-form">
                        <input type="number" class="form-input" placeholder="Default Validity Days (e.g., 30)" id="default-validity" min="1" max="365">
                        <textarea class="form-input" placeholder="Default Terms & Conditions" id="default-terms" rows="4" style="resize: none; min-height: 100px;"></textarea>
                        <input type="text" class="form-input" placeholder="Quotation Prefix (e.g., QUO)" id="quotation-prefix">
                        
                        <button type="submit" class="btn btn-purple" style="width: 100%;">
                            üìã Save Quotation Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-items">
                <div class="nav-item active" onclick="showView('dashboard')">
                    <span class="icon">üè†</span>
                    <span>Home</span>
                </div>
                <div class="nav-item" onclick="showView('customers')">
                    <span class="icon">üë•</span>
                    <span>Customers</span>
                    <span class="badge hidden" id="customers-badge">0</span>
                </div>
                <div class="nav-item" onclick="showView('products')">
                    <span class="icon">ü•¨</span>
                    <span>Products</span>
                    <span class="badge hidden" id="low-stock-badge">0</span>
                </div>
                <div class="nav-item" onclick="showView('quotations')">
                    <span class="icon">üìã</span>
                    <span>Quotes</span>
                    <span class="badge hidden" id="pending-quotes-badge">0</span>
                </div>
                <div class="nav-item" onclick="showView('orders')">
                    <span class="icon">üõí</span>
                    <span>Orders</span>
                    <span class="badge hidden" id="pending-orders-badge">0</span>
                </div>
                <div class="nav-item" onclick="showView('settings')">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <div id="notification" class="notification">
        <span id="notification-icon">‚úÖ</span>
        <span id="notification-text">Success!</span>
    </div>

    <!-- Enhanced Modals -->
    <!-- Customer Modal -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customer-modal-title">Add Customer</h3>
                <button class="close-btn" onclick="closeCustomerForm()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <input type="text" class="form-input" placeholder="Customer Name *" id="customer-name" required>
                    <div class="form-error hidden" id="customer-name-error"></div>
                    
                    <input type="tel" class="form-input" placeholder="Phone Number" id="customer-phone">
                    <div class="form-error hidden" id="customer-phone-error"></div>
                    
                    <textarea class="form-input" placeholder="Address" id="customer-address" rows="3" style="resize: none; min-height: 80px;"></textarea>
                    
                    <input type="email" class="form-input" placeholder="Email" id="customer-email">
                    <div class="form-error hidden" id="customer-email-error"></div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 24px;">
                        <button type="submit" class="btn btn-success">Save</button>
                        <button type="button" class="btn btn-gray" onclick="closeCustomerForm()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quotation Form Modal -->
    <div id="quotation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="quotation-modal-title">Create Quotation</h3>
                <button class="close-btn" onclick="closeQuotationForm()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="quotation-form">
                    <label style="display: block; color: #374151; font-weight: 700; margin-bottom: 12px; font-size: 16px;">Select Customer *</label>
                    <select class="form-input" id="quotation-customer" required style="color: #374151; font-weight: 600;">
                        <option value="">Choose customer...</option>
                    </select>
                    
                    <label style="display: block; color: #374151; font-weight: 700; margin-bottom: 12px; font-size: 16px;">Validity Period</label>
                    <input type="number" class="form-input" placeholder="Valid for (days)" id="quotation-validity" min="1" max="365" value="30">
                    
                    <div id="quotation-items" class="hidden">
                        <label style="display: block; color: #374151; font-weight: 700; margin-bottom: 12px; font-size: 16px;">Quotation Items</label>
                        
                        <div style="position: relative; margin-bottom: 16px;">
                            <input type="text" placeholder="Search vegetables..." id="quotation-search" 
                                   style="width: 100%; padding: 12px 16px 12px 40px; border-radius: 12px; border: 1px solid #d1d5db; font-size: 14px;"
                                   oninput="filterQuotationItems(this.value)">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">üîç</span>
                        </div>
                        
                        <div class="category-filters" id="quotation-category-filters" style="margin-bottom: 16px;">
                            <!-- Categories populated by JavaScript -->
                        </div>
                        
                        <div id="quotation-items-list" style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;"></div>
                        
                        <div style="background: linear-gradient(135deg, #ecfeff, #cffafe); border-radius: 16px; padding: 20px; margin: 20px 0; border: 1px solid #67e8f9;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 700; font-size: 18px; color: #1f2937;">Total Amount:</span>
                                <span style="font-size: 28px; font-weight: 800; color: #0e7490;" id="quotation-total">RM 0.00</span>
                            </div>
                        </div>
                        
                        <label style="display: block; color: #374151; font-weight: 700; margin-bottom: 12px; font-size: 16px;">Terms & Conditions</label>
                        <textarea class="form-input" placeholder="Terms and conditions..." id="quotation-terms" rows="4" style="resize: none; min-height: 100px;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 24px;">
                        <button type="submit" class="btn btn-purple">Create Quote</button>
                        <button type="button" class="btn btn-gray" onclick="closeQuotationForm()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quotation Details Modal -->
    <div id="quotation-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Quotation Details</h3>
                <button class="close-btn" onclick="closeQuotationDetails()">‚úï</button>
            </div>
            <div class="modal-body" id="quotation-details-content">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Quotation Display Modal (Professional View) -->
    <div id="quotation-display-modal" class="modal">
        <div class="modal-content" style="max-height: 90vh;">
            <div class="modal-header">
                <h3>üìã Professional Quotation</h3>
                <button class="close-btn" onclick="closeQuotationDisplay()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Share Buttons -->
                <div class="share-buttons">
                    <button class="share-btn whatsapp" onclick="shareQuotationWhatsApp()">
                        <span>üí¨</span>
                        <span>WhatsApp</span>
                    </button>
                    <button class="share-btn email" onclick="shareQuotationEmail()">
                        <span>üìß</span>
                        <span>Email</span>
                    </button>
                    <button class="share-btn pdf" onclick="generateQuotationPDF()">
                        <span>üìÑ</span>
                        <span>PDF</span>
                    </button>
                </div>
                
                <!-- Quotation Content -->
                <div id="quotation-display-content" style="background: white; border-radius: 16px; padding: 24px; color: #1f2937; font-family: 'Times New Roman', serif;">
                    <!-- Content populated by JavaScript -->
                </div>
                
                <!-- Action Buttons -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="convertQuotationToOrder()" id="convert-to-order-btn">
                        ‚úÖ Convert to Order
                    </button>
                    <button class="btn btn-warning" onclick="markQuotationSent()" id="mark-sent-btn">
                        üì§ Mark as Sent
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Enhanced App State and Classes with Quotations
        class VegeOrderApp {
            constructor() {
                this.currentView = 'dashboard';
                this.customers = [];
                this.products = [];
                this.orders = [];
                this.quotations = []; // New: Quotations array
                this.selectedDate = new Date().toISOString().split('T')[0];
                this.orderFilter = 'all';
                this.quotationFilter = 'all'; // New: Quotation filter
                this.editingCustomer = null;
                this.editingProduct = null;
                this.editingOrder = null;
                this.editingQuotation = null; // New: Editing quotation
                this.selectedCategory = 'all';
                this.selectedQuotationCategory = 'all'; // New: Quotation category filter
                this.isOnline = navigator.onLine;
                this.syncQueue = [];
                this.currentQuotationDetails = null; // New: Current quotation for display
                
                // Enhanced features
                this.searchEngine = new SearchEngine();
                this.analytics = new BusinessAnalytics();
                this.notificationManager = new NotificationManager();
                this.inventoryManager = new InventoryManager();
                this.storage = new VegeOrderStorage();
                
                this.companySettings = {
                    name: '',
                    tagline: '',
                    phone: '',
                    email: '',
                    website: '',
                    address: '',
                    invoicePrefix: 'INV',
                    paymentTerms: 7,
                    taxRate: 0,
                    invoiceNotes: '',
                    ownerName: '',
                    ownerTitle: '',
                    ownerPhone: '',
                    ownerEmail: '',
                    // New: Quotation settings
                    quotationPrefix: 'QUO',
                    defaultValidityDays: 30,
                    defaultTerms: 'This quotation is valid for 30 days from the date of issue. Prices are subject to change without notice. Payment terms: Net 30 days.'
                };
                
                // New: Customer slot management
                this.customerSlots = {
                    total: 10, // Free tier: 10 customers
                    used: 0,
                    remaining: 10,
                    plan: 'free', // free, premium, enterprise
                    addonSlots: 0,
                    lastUpgrade: null,
                    upgradeHistory: []
                };
                
                // Storage Keys
                this.STORAGE_KEYS = {
                    COMPANY_SETTINGS: 'vegeorder_company_settings',
                    CUSTOMERS: 'vegeorder_customers',
                    PRODUCTS: 'vegeorder_products',
                    ORDERS: 'vegeorder_orders',
                    QUOTATIONS: 'vegeorder_quotations',
                    CUSTOMER_SLOTS: 'vegeorder_customer_slots' // New
                };
                
                this.init();
            }
            
            async init() {
                await this.loadDataFromStorage();
                this.setupEventListeners();
                this.setupConnectionHandling();
                this.updateStatusBar();
                this.updateCurrentDate();
                this.updateStats();
                this.updateAnalytics();
                this.renderViews();
                this.checkLowStock();
                this.setupNotifications();
                this.updateCustomerSlotUsage(); // New: Update slot usage
                
                // Enhanced mobile features
                this.preventZoom();
                this.setupTouchFeedback();
                this.setupPullToRefresh();
                
                console.log('ü•¨ VegeOrder Pro with Quotations and Customer Slots initialized!');
            }
            
            async loadDataFromStorage() {
                try {
                    const savedSettings = await this.storage.loadData(this.STORAGE_KEYS.COMPANY_SETTINGS);
                    if (savedSettings) {
                        this.companySettings = { ...this.companySettings, ...savedSettings };
                    }
                    
                    const savedCustomers = await this.storage.loadData(this.STORAGE_KEYS.CUSTOMERS);
                    if (savedCustomers) {
                        this.customers = savedCustomers;
                    }
                    
                    const savedProducts = await this.storage.loadData(this.STORAGE_KEYS.PRODUCTS);
                    if (savedProducts) {
                        this.products = savedProducts;
                    }
                    
                    const savedOrders = await this.storage.loadData(this.STORAGE_KEYS.ORDERS);
                    if (savedOrders) {
                        this.orders = savedOrders;
                    }
                    
                    // New: Load quotations
                    const savedQuotations = await this.storage.loadData(this.STORAGE_KEYS.QUOTATIONS);
                    if (savedQuotations) {
                        this.quotations = savedQuotations;
                    }
                    
                    // New: Load customer slots
                    const savedCustomerSlots = await this.storage.loadData(this.STORAGE_KEYS.CUSTOMER_SLOTS);
                    if (savedCustomerSlots) {
                        this.customerSlots = { ...this.customerSlots, ...savedCustomerSlots };
                    }
                    
                    // Update customer slot usage
                    this.updateCustomerSlotUsage();
                } catch (error) {
                    console.error('Error loading data:', error);
                }
                
                if (this.customers.length === 0) {
                    this.loadInitialData();
                }
            }
            
            loadInitialData() {
                // Enhanced sample data with more realistic Malaysian customers
                this.customers = [
                    { id: 1, name: 'Restoran Ahmad Nasi Kandar', phone: '012-3456789', address: 'Jalan Sultan, KL', email: 'ahmad@nasikandar.com' },
                    { id: 2, name: 'Siti Catering & Events', phone: '013-7654321', address: 'Taman Desa, PJ', email: 'siti@catering.my' },
                    { id: 3, name: 'Lee Kitchen Chinese Restaurant', phone: '019-9876543', address: 'Chinatown, KL', email: 'lee@kitchen.com' },
                    { id: 4, name: 'Warung Mak Cik Kiah', phone: '017-1234567', address: 'Kampung Baru, KL', email: 'kiah@warung.my' },
                    { id: 5, name: 'Mamak Rashid 24 Jam', phone: '016-2345678', address: 'Shah Alam', email: 'rashid@mamak.my' },
                    { id: 6, name: 'Restoran Sedap Rasa', phone: '014-3456789', address: 'Subang Jaya', email: 'sedap@restaurant.my' }
                ];
                
                // Comprehensive Malaysian vegetable catalog
                this.products = [
                    // Leafy Greens
                    { id: 1, name: 'Kangkung ÈÄöËèú (Water Spinach)', unit: 'kg', price: 4.50, category: 'Leafy Greens', stock: 50 },
                    { id: 2, name: 'Sawi Hijau Ëä•Ëèú (Chinese Mustard Green)', unit: 'kg', price: 5.00, category: 'Leafy Greens', stock: 30 },
                    { id: 3, name: 'Sawi Putih ÁôΩËèú (Chinese Cabbage)', unit: 'kg', price: 4.80, category: 'Leafy Greens', stock: 25 },
                    { id: 4, name: 'Spinach Ëè†Ëèú (Bayam Pasir)', unit: 'kg', price: 8.50, category: 'Leafy Greens', stock: 15 },
                    { id: 5, name: 'Lettuce Iceberg ÂÜ∞Â±±ÁîüËèú', unit: 'head', price: 4.50, category: 'Leafy Greens', stock: 20 },
                    { id: 6, name: 'Pak Choy ÁôΩËèú (Bok Choy)', unit: 'kg', price: 5.50, category: 'Leafy Greens', stock: 35 },
                    { id: 7, name: 'Kailan Ëä•ÂÖ∞ (Chinese Broccoli)', unit: 'kg', price: 7.00, category: 'Leafy Greens', stock: 28 },
                    
                    // Malaysian Specialties
                    { id: 8, name: 'Petai Ëá≠Ë±Ü (Stink Bean)', unit: 'kg', price: 18.00, category: 'Malaysian Specialty', stock: 12 },
                    { id: 9, name: 'Jering Ëá≠È≥ûË±Ü', unit: 'kg', price: 15.00, category: 'Malaysian Specialty', stock: 8 },
                    { id: 10, name: 'Rebung Á´πÁ¨ã (Bamboo Shoots)', unit: 'kg', price: 8.50, category: 'Malaysian Specialty', stock: 22 },
                    
                    // Gourds & Squash
                    { id: 11, name: 'Labu Kuning ÂçóÁìú (Pumpkin)', unit: 'kg', price: 3.20, category: 'Gourds & Squash', stock: 40 },
                    { id: 12, name: 'Petola ‰∏ùÁìú (Luffa/Sponge Gourd)', unit: 'kg', price: 4.50, category: 'Gourds & Squash', stock: 18 },
                    { id: 13, name: 'Peria Ëã¶Áìú (Bitter Gourd)', unit: 'kg', price: 8.00, category: 'Gourds & Squash', stock: 16 },
                    { id: 14, name: 'Timun ÈªÑÁìú (Cucumber)', unit: 'kg', price: 3.80, category: 'Gourds & Squash', stock: 45 },
                    
                    // More categories...
                    { id: 15, name: 'Terung Ungu Á¥´ËåÑÂ≠ê (Purple Eggplant)', unit: 'kg', price: 5.50, category: 'Eggplants & Tomatoes', stock: 24 },
                    { id: 16, name: 'Tomato Biasa Áï™ËåÑ (Regular Tomato)', unit: 'kg', price: 6.00, category: 'Eggplants & Tomatoes', stock: 32 },
                    { id: 17, name: 'Bendi ÁßãËëµ (Okra/Ladies Finger)', unit: 'kg', price: 7.20, category: 'Beans & Pods', stock: 19 },
                    { id: 18, name: 'Kacang Panjang ÈïøË±Ü (Long Beans)', unit: 'kg', price: 6.50, category: 'Beans & Pods', stock: 38 },
                    { id: 19, name: 'Taugeh Ë±ÜËäΩËèú (Bean Sprouts)', unit: 'kg', price: 3.50, category: 'Beans & Pods', stock: 60 },
                    { id: 20, name: 'Bawang Merah Á∫¢Ëë±Â§¥ (Shallots)', unit: 'kg', price: 8.00, category: 'Onions & Aromatics', stock: 25 },
                    { id: 21, name: 'Bawang Putih ËíúÂ§¥ (Garlic)', unit: 'kg', price: 18.00, category: 'Onions & Aromatics', stock: 15 },
                    { id: 22, name: 'Bawang Besar Merah Á∫¢Ê¥ãËë± (Red Onions)', unit: 'kg', price: 5.00, category: 'Onions & Aromatics', stock: 30 },
                    { id: 23, name: 'Cili Merah Á∫¢Ëæ£Ê§í (Red Chili)', unit: 'kg', price: 15.00, category: 'Peppers & Chilies', stock: 12 },
                    { id: 24, name: 'Cili Padi Â∞èËæ£Ê§í (Bird Eye Chili)', unit: 'kg', price: 25.00, category: 'Peppers & Chilies', stock: 6 },
                    { id: 25, name: 'Capsicum Merah Á∫¢ÁîúÊ§í (Red Bell Pepper)', unit: 'kg', price: 14.00, category: 'Peppers & Chilies', stock: 14 },
                    { id: 26, name: 'Lobak Merah ËÉ°ËêùÂçú (Carrots)', unit: 'kg', price: 5.20, category: 'Root Vegetables', stock: 42 },
                    { id: 27, name: 'Kentang È©¨ÈìÉËñØ (Potato)', unit: 'kg', price: 4.00, category: 'Root Vegetables', stock: 55 },
                    { id: 28, name: 'Ubi Kentang Merah Á∫¢ËñØ (Red Sweet Potato)', unit: 'kg', price: 4.20, category: 'Root Vegetables', stock: 33 }
                ];
                
                this.orders = [];
                
                // New: Sample quotations
                this.quotations = [
                    {
                        id: 1,
                        customerId: 1,
                        quotationNumber: 'QUO-2025010-001',
                        date: new Date().toISOString().split('T')[0],
                        validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'sent',
                        items: [
                            { vegeId: 1, vegeName: 'Kangkung ÈÄöËèú (Water Spinach)', unit: 'kg', price: 4.50, quantity: 10 },
                            { vegeId: 2, vegeName: 'Sawi Hijau Ëä•Ëèú (Chinese Mustard Green)', unit: 'kg', price: 5.00, quantity: 5 }
                        ],
                        total: 70.00,
                        terms: 'This quotation is valid for 30 days from the date of issue. Prices are subject to change without notice.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                this.saveDataToStorage();
            }
            
            saveDataToStorage() {
                this.storage.saveData(this.STORAGE_KEYS.COMPANY_SETTINGS, this.companySettings);
                this.storage.saveData(this.STORAGE_KEYS.CUSTOMERS, this.customers);
                this.storage.saveData(this.STORAGE_KEYS.PRODUCTS, this.products);
                this.storage.saveData(this.STORAGE_KEYS.ORDERS, this.orders);
                this.storage.saveData(this.STORAGE_KEYS.QUOTATIONS, this.quotations);
                this.storage.saveData(this.STORAGE_KEYS.CUSTOMER_SLOTS, this.customerSlots); // New
            }
            
            // New: Update customer slot usage
            updateCustomerSlotUsage() {
                this.customerSlots.used = this.customers.length;
                this.customerSlots.remaining = this.customerSlots.total - this.customerSlots.used;
                
                // Check for warnings
                if (this.customerSlots.remaining <= 2 && this.customerSlots.remaining > 0) {
                    this.showCustomerSlotWarning();
                } else if (this.customerSlots.remaining <= 0) {
                    this.showCustomerSlotLimitReached();
                }
            }
            
            // New: Show customer slot warning
            showCustomerSlotWarning() {
                const remaining = this.customerSlots.remaining;
                this.showNotification(`‚ö†Ô∏è Only ${remaining} customer slot${remaining === 1 ? '' : 's'} remaining! Upgrade to add more.`, 'warning');
            }
            
            // New: Show customer slot limit reached
            showCustomerSlotLimitReached() {
                this.showNotification('üö´ Customer limit reached! Upgrade to add more customers.', 'error');
            }
            
            // New: Check if can add customer
            canAddCustomer() {
                return this.customerSlots.remaining > 0;
            }
            
            // New: Add customer slots (purchase)
            addCustomerSlots(quantity, plan = 'addon') {
                const upgrade = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    plan: plan,
                    slotsAdded: quantity,
                    price: this.calculateSlotPrice(quantity, plan),
                    paymentMethod: 'simulated'
                };
                
                this.customerSlots.total += quantity;
                this.customerSlots.addonSlots += quantity;
                this.customerSlots.lastUpgrade = new Date().toISOString();
                this.customerSlots.upgradeHistory.push(upgrade);
                
                this.updateCustomerSlotUsage();
                this.saveDataToStorage();
                
                this.showNotification(`üéâ Successfully added ${quantity} customer slots!`, 'success');
                return true;
            }
            
            // New: Calculate slot price
            calculateSlotPrice(quantity, plan) {
                const prices = {
                    addon: 2.00, // RM 2.00 per slot for addon
                    premium: 1.50, // RM 1.50 per slot for premium bundle
                    enterprise: 1.00 // RM 1.00 per slot for enterprise
                };
                
                return quantity * (prices[plan] || prices.addon);
            }
            
            // New: Upgrade to premium plan
            upgradeToPremium() {
                const premiumSlots = 100;
                const currentAddonSlots = this.customerSlots.addonSlots;
                
                this.customerSlots.plan = 'premium';
                this.customerSlots.total = premiumSlots + currentAddonSlots;
                
                const upgrade = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    plan: 'premium',
                    slotsAdded: premiumSlots - 10, // Minus the original 10 free slots
                    price: 99.00, // RM 99 for premium plan
                    paymentMethod: 'simulated'
                };
                
                this.customerSlots.lastUpgrade = new Date().toISOString();
                this.customerSlots.upgradeHistory.push(upgrade);
                
                this.updateCustomerSlotUsage();
                this.saveDataToStorage();
                
                this.showNotification('üéâ Upgraded to Premium Plan! You now have 100 customer slots.', 'success');
                return true;
            }
            
            setupEventListeners() {
                // Enhanced event listeners with better error handling
                document.getElementById('order-date').value = this.selectedDate;
                document.getElementById('order-date').addEventListener('change', (e) => {
                    this.selectedDate = e.target.value;
                    this.renderOrders();
                    this.updateStats();
                });
                
                // Order filters
                document.querySelectorAll('[data-filter]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.orderFilter = btn.dataset.filter;
                        this.renderOrders();
                    });
                });
                
                // Forms
                document.getElementById('customer-form').addEventListener('submit', (e) => this.handleCustomerSubmit(e));
                document.getElementById('company-form').addEventListener('submit', (e) => this.handleCompanySubmit(e));
                
                // New: Quotation form and settings
                document.getElementById('quotation-form').addEventListener('submit', (e) => this.handleQuotationSubmit(e));
                document.getElementById('quotation-settings-form').addEventListener('submit', (e) => this.handleQuotationSettingsSubmit(e));
                
                // New: Quotation customer selection
                document.getElementById('quotation-customer').addEventListener('change', () => {
                    if (document.getElementById('quotation-customer').value) {
                        this.initializeQuotationItems();
                    } else {
                        document.getElementById('quotation-items').classList.add('hidden');
                    }
                });
            }
            
            setupConnectionHandling() {
                const statusIndicator = document.getElementById('connection-status');
                
                const updateConnectionStatus = () => {
                    this.isOnline = navigator.onLine;
                    statusIndicator.className = `connection-status ${this.isOnline ? '' : 'offline'}`;
                    
                    if (this.isOnline) {
                        this.syncPendingData();
                        this.showNotification('üåê Back online!', 'success');
                    } else {
                        this.showNotification('üì¥ Offline mode', 'warning');
                    }
                };
                
                window.addEventListener('online', updateConnectionStatus);
                window.addEventListener('offline', updateConnectionStatus);
                
                updateConnectionStatus();
            }
            
            updateStatusBar() {
                const now = new Date();
                const timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
                document.getElementById('status-time').textContent = timeStr;
            }
            
            updateCurrentDate() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-MY', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'short' 
                });
                document.getElementById('current-date').textContent = dateStr;
            }
            
            updateStats() {
                const todayOrders = this.orders.filter(order => order.date === this.selectedDate);
                const totalSales = todayOrders.reduce((sum, order) => sum + order.total, 0);
                const pendingCount = todayOrders.filter(order => order.status === 'pending').length;
                const completedCount = todayOrders.filter(order => order.status === 'completed').length;
                
                // New: Quotation stats
                const pendingQuotations = this.quotations.filter(q => q.status === 'pending' || q.status === 'sent').length;
                
                // Update basic stats
                document.getElementById('customers-count').textContent = this.customers.length;
                document.getElementById('products-count').textContent = this.products.length;
                document.getElementById('orders-count').textContent = todayOrders.length;
                document.getElementById('quotations-count').textContent = this.quotations.length;
                document.getElementById('daily-sales').textContent = 'RM ' + totalSales.toFixed(2);
                
                // New: Update customer slot display in trends
                const customersTrendElement = document.getElementById('customers-trend');
                if (customersTrendElement) {
                    const usage = `${this.customers.length}/${this.customerSlots.total}`;
                    customersTrendElement.textContent = usage;
                    customersTrendElement.className = 'stat-trend ' + 
                        (this.customerSlots.remaining <= 2 ? 'trend-down' : 
                         this.customerSlots.remaining <= 5 ? 'trend-neutral' : 'trend-up');
                }
                
                // Update revenue display
                const revenueShort = totalSales >= 1000 ? 
                    (totalSales / 1000).toFixed(1) + 'K' : 
                    totalSales.toFixed(0);
                document.getElementById('revenue-short').textContent = revenueShort;
                
                // Update navigation badges
                this.updateNavigationBadges();
            }
            
            updateNavigationBadges() {
                const pendingOrders = this.orders.filter(order => order.status === 'pending').length;
                const lowStockItems = this.inventoryManager ? this.inventoryManager.getLowStockItems().length : 0;
                const pendingQuotations = this.quotations.filter(q => q.status === 'pending' || q.status === 'sent').length; // New
                
                const pendingOrdersBadge = document.getElementById('pending-orders-badge');
                const lowStockBadge = document.getElementById('low-stock-badge');
                const pendingQuotesBadge = document.getElementById('pending-quotes-badge'); // New
                
                if (pendingOrders > 0) {
                    pendingOrdersBadge.textContent = pendingOrders;
                    pendingOrdersBadge.classList.remove('hidden');
                } else {
                    pendingOrdersBadge.classList.add('hidden');
                }
                
                if (lowStockItems > 0) {
                    lowStockBadge.textContent = lowStockItems;
                    lowStockBadge.classList.remove('hidden');
                } else {
                    lowStockBadge.classList.add('hidden');
                }
                
                // New: Pending quotations badge
                if (pendingQuotations > 0) {
                    pendingQuotesBadge.textContent = pendingQuotations;
                    pendingQuotesBadge.classList.remove('hidden');
                } else {
                    pendingQuotesBadge.classList.add('hidden');
                }
            }
            
            updateAnalytics() {
                const analytics = this.analytics.generateDashboardData(7);
                const avgOrderValue = analytics.salesTrend.length > 0 ? 
                    analytics.salesTrend.reduce((sum, day) => sum + day.sales, 0) / analytics.salesTrend.length : 0;
                
                document.getElementById('avg-order-value').textContent = 'RM ' + avgOrderValue.toFixed(0);
                
                if (analytics.topProducts.length > 0) {
                    const topProduct = analytics.topProducts[0];
                    const productName = topProduct.name.split(' ')[0]; // First word only
                    document.getElementById('top-product').textContent = productName;
                }
                
                // Calculate growth rate
                const currentWeekSales = analytics.salesTrend.slice(-7).reduce((sum, day) => sum + day.sales, 0);
                const previousWeekSales = analytics.salesTrend.slice(-14, -7).reduce((sum, day) => sum + day.sales, 0);
                const growthRate = previousWeekSales > 0 ? 
                    ((currentWeekSales - previousWeekSales) / previousWeekSales * 100).toFixed(1) : 0;
                
                document.getElementById('growth-rate').textContent = growthRate + '%';
                document.getElementById('total-customers').textContent = this.customers.length;
            }
            
            checkLowStock() {
                if (!this.inventoryManager) return;
                
                const lowStockItems = this.inventoryManager.getLowStockItems();
                const alertsContainer = document.getElementById('low-stock-alerts');
                
                if (lowStockItems.length > 0) {
                    const alertsHTML = lowStockItems.map(item => `
                        <div class="low-stock-alert">
                            <div class="icon">‚ö†Ô∏è</div>
                            <div class="low-stock-content">
                                <h4>Low Stock Alert</h4>
                                <p>${item.name} - Only ${item.currentStock} ${item.unit} remaining</p>
                            </div>
                        </div>
                    `).join('');
                    
                    alertsContainer.innerHTML = alertsHTML;
                } else {
                    alertsContainer.innerHTML = '';
                }
            }
            
            setupNotifications() {
                if ('Notification' in window && 'serviceWorker' in navigator) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('‚úÖ Notifications enabled');
                        }
                    });
                }
            }
            
            showNotification(text, type = 'success', icon = '‚úÖ') {
                const notification = document.getElementById('notification');
                const notificationIcon = document.getElementById('notification-icon');
                const notificationText = document.getElementById('notification-text');
                
                notification.className = `notification ${type}`;
                
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                
                notificationIcon.textContent = icons[type] || icon;
                notificationText.textContent = text;
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            syncPendingData() {
                if (this.syncQueue.length > 0 && this.isOnline) {
                    console.log(`üîÑ Syncing ${this.syncQueue.length} pending changes...`);
                    // Process sync queue here
                    this.syncQueue = [];
                }
            }
            
            preventZoom() {
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('focus', () => {
                        input.style.fontSize = '16px';
                    });
                });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (event) => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            setupTouchFeedback() {
                document.addEventListener('touchstart', (e) => {
                    const target = e.target;
                    if (target.matches('button, .nav-item, .item-card, .action-btn, .icon-btn, .category-btn, .stat-card, .quotation-card')) {
                        if (navigator.vibrate) {
                            navigator.vibrate(10);
                        }
                    }
                }, {passive: true});
            }
            
            setupPullToRefresh() {
                const mainContent = document.getElementById('main-content');
                let startY = 0;
                let isPulling = false;
                
                mainContent.addEventListener('touchstart', (e) => {
                    if (mainContent.scrollTop === 0) {
                        startY = e.touches[0].clientY;
                        isPulling = true;
                    }
                }, {passive: true});
                
                mainContent.addEventListener('touchend', () => {
                    if (isPulling) {
                        // Refresh data
                        this.updateStats();
                        this.updateAnalytics();
                        this.renderViews();
                        this.showNotification('üîÑ Data refreshed', 'success');
                        isPulling = false;
                    }
                }, {passive: true});
            }
            
            showView(viewName) {
                // Hide all views
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.add('hidden');
                });
                
                // Show selected view
                document.getElementById(viewName + '-view').classList.remove('hidden');
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    const onclick = item.getAttribute('onclick');
                    if (onclick && onclick.includes(viewName)) {
                        item.classList.add('active');
                    }
                });
                
                this.currentView = viewName;
                this.renderViews();
                
                // Scroll to top
                document.getElementById('main-content').scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
            
            renderViews() {
                switch (this.currentView) {
                    case 'dashboard':
                        this.renderRecentActivity(); // Updated to show both orders and quotations
                        break;
                    case 'customers':
                        this.renderCustomers();
                        break;
                    case 'products':
                        this.setupCategoryFilters();
                        this.renderProducts();
                        break;
                    case 'orders':
                        this.renderOrders();
                        break;
                    case 'quotations': // New view
                        this.renderQuotations();
                        break;
                }
            }
            
            // New: Render recent activity (orders and quotations)
            renderRecentActivity() {
                const todayOrders = this.orders.filter(order => order.date === this.selectedDate);
                const recentQuotations = this.quotations.slice(-3); // Last 3 quotations
                const container = document.getElementById('recent-activity');
                
                if (todayOrders.length === 0 && recentQuotations.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">‚è∞</div>
                            <p style="font-weight: 600;">No recent activity</p>
                            <p style="font-size: 14px; margin-top: 8px;">Create your first order or quotation to get started</p>
                        </div>`;
                    return;
                }
                
                let activityHTML = '';
                
                // Add recent quotations
                recentQuotations.forEach(quotation => {
                    const customer = this.customers.find(c => c.id === quotation.customerId);
                    const customerName = customer ? customer.name : 'Unknown';
                    
                    activityHTML += `
                        <div class="item-card" onclick="showQuotationDetails(${quotation.id})">
                            <div class="item-header">
                                <div class="item-info">
                                    <h3>üìã ${customerName}</h3>
                                    <div class="item-meta">
                                        <span class="icon">üÜî</span>
                                        <span>${quotation.quotationNumber}</span>
                                    </div>
                                    <div class="item-meta">
                                        <span class="icon">üïê</span>
                                        <span>${new Date(quotation.createdAt).toLocaleDateString()}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: 700; color: #7c3aed; margin-bottom: 8px;">
                                        RM ${quotation.total.toFixed(2)}
                                    </div>
                                    <span class="quotation-status status-${quotation.status}">
                                        ${quotation.status}
                                    </span>
                                </div>
                            </div>
                        </div>`;
                });
                
                // Add recent orders
                const displayCount = Math.min(todayOrders.length, 2);
                todayOrders.slice(0, displayCount).forEach(order => {
                    const customer = this.customers.find(c => c.id === order.customerId);
                    const customerName = customer ? customer.name : 'Unknown';
                    
                    activityHTML += `
                        <div class="item-card" onclick="showOrderDetails(${order.id})">
                            <div class="item-header">
                                <div class="item-info">
                                    <h3>üõí ${customerName}</h3>
                                    <div class="item-meta">
                                        <span class="icon">üì¶</span>
                                        <span>${order.items.length} items</span>
                                    </div>
                                    <div class="item-meta">
                                        <span class="icon">üïê</span>
                                        <span>${new Date(order.createdAt).toLocaleTimeString()}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: 700; color: #22d3ee; margin-bottom: 8px;">
                                        RM ${order.total.toFixed(2)}
                                    </div>
                                    <span class="category-btn ${order.status === 'completed' ? 'active' : ''}" style="font-size: 11px; padding: 4px 8px;">
                                        ${order.status}
                                    </span>
                                </div>
                            </div>
                        </div>`;
                });
                
                container.innerHTML = activityHTML;
            }
            
            renderCustomers() {
                const container = document.getElementById('customers-list');
                
                if (this.customers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <p style="font-weight: 600;">No customers yet</p>
                            <p style="font-size: 14px; margin-top: 8px;">Add your first customer to get started</p>
                        </div>`;
                    return;
                }
                
                const customersHTML = this.customers.map(customer => {
                    const customerOrders = this.orders.filter(order => order.customerId === customer.id);
                    const customerQuotations = this.quotations.filter(quotation => quotation.customerId === customer.id); // New
                    const customerTotal = customerOrders.reduce((sum, order) => sum + order.total, 0);
                    
                    return `
                        <div class="item-card">
                            <div class="item-header">
                                <div class="item-info">
                                    <h3>${customer.name}</h3>
                                    <div class="item-meta">
                                        <span class="icon">üìû</span>
                                        <span>${customer.phone}</span>
                                    </div>
                                    ${customer.address ? `
                                        <div class="item-meta">
                                            <span class="icon">üìç</span>
                                            <span>${customer.address}</span>
                                        </div>
                                    ` : ''}
                                    ${customer.email ? `
                                        <div class="item-meta">
                                            <span class="icon">üìß</span>
                                            <span>${customer.email}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="icon-btn primary" onclick="editCustomer(${customer.id})">‚úèÔ∏è</button>
                                    <button class="icon-btn danger" onclick="deleteCustomer(${customer.id})">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; display: flex; justify-content: space-between; font-size: 14px;">
                                <span style="color: rgba(255,255,255,0.8);">${customerOrders.length} orders ‚Ä¢ ${customerQuotations.length} quotes</span>
                                <span style="font-weight: 700; color: #22d3ee;">RM ${customerTotal.toFixed(2)}</span>
                            </div>
                        </div>`;
                }).join('');
                
                container.innerHTML = customersHTML;
            }
            
            renderProducts() {
                const container = document.getElementById('products-list');
                
                if (this.products.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ü•¨</div>
                            <p style="font-weight: 600;">No products yet</p>
                            <p style="font-size: 14px; margin-top: 8px;">Add your first vegetable to get started</p>
                        </div>`;
                    return;
                }
                
                const productsHTML = this.products.map(product => {
                    const stockLevel = product.stock || 0;
                    const stockColor = stockLevel < 10 ? '#ef4444' : stockLevel < 20 ? '#f59e0b' : '#22c55e';
                    
                    return `
                        <div class="item-card">
                            <div class="item-header">
                                <div class="item-info">
                                    <h3>${product.name}</h3>
                                    <div class="item-meta">
                                        <span class="icon">üí∞</span>
                                        <span>RM ${product.price.toFixed(2)} per ${product.unit}</span>
                                    </div>
                                    <div class="item-meta">
                                        <span class="icon">üì¶</span>
                                        <span style="color: ${stockColor};">Stock: ${stockLevel} ${product.unit}</span>
                                    </div>
                                    ${product.category ? `
                                        <span class="category-btn" style="font-size: 11px; padding: 4px 8px; margin-top: 8px;">
                                            ${product.category}
                                        </span>
                                    ` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="icon-btn primary" onclick="editProduct(${product.id})">‚úèÔ∏è</button>
                                    <button class="icon-btn danger" onclick="deleteProduct(${product.id})">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>`;
                }).join('');
                
                container.innerHTML = productsHTML;
            }
            
            renderOrders() {
                const todayOrders = this.orders.filter(order => order.date === this.selectedDate);
                const filteredOrders = todayOrders.filter(order => {
                    if (this.orderFilter === 'pending') return order.status === 'pending';
                    if (this.orderFilter === 'completed') return order.status === 'completed';
                    return true;
                });
                
                const container = document.getElementById('orders-list');
                
                if (filteredOrders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üõí</div>
                            <p style="font-weight: 600;">No orders found</p>
                            <p style="font-size: 14px; margin-top: 8px;">Create your first order to get started</p>
                        </div>`;
                    return;
                }
                
                const ordersHTML = filteredOrders.map(order => {
                    const customer = this.customers.find(c => c.id === order.customerId);
                    const customerName = customer ? customer.name : 'Unknown';
                    
                    const itemsPreview = order.items.slice(0, 2).map(item => 
                        `${item.vegeName}: ${item.quantity} ${item.unit}`
                    ).join('<br>');
                    
                    const moreItems = order.items.length > 2 ? 
                        `<br><small style="color: rgba(255,255,255,0.7);">+${order.items.length - 2} more items</small>` : '';
                    
                    return `
                        <div class="item-card" onclick="showOrderDetails(${order.id})">
                            <div class="item-header">
                                <div class="item-info">
                                    <h3>${customerName}</h3>
                                    <div class="item-meta">
                                        <span class="icon">üÜî</span>
                                        <span>#${order.id}</span>
                                    </div>
                                    <div class="item-meta">
                                        <span class="icon">üïê</span>
                                        <span>${new Date(order.createdAt).toLocaleString()}</span>
                                    </div>
                                    <div style="margin-top: 12px; font-size: 14px; line-height: 1.4;">
                                        ${itemsPreview}${moreItems}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="category-btn ${order.status === 'completed' ? 'active' : ''}" style="font-size: 11px; padding: 4px 8px; margin-bottom: 8px;">
                                        ${order.status}
                                    </span>
                                    <div style="font-size: 20px; font-weight: 700; color: #22d3ee;">
                                        RM ${order.total.toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }).join('');
                
                container.innerHTML = ordersHTML;
            }
            
            // New: Render quotations
            renderQuotations() {
                const filteredQuotations = this.quotations.filter(quotation => {
                    if (this.quotationFilter === 'pending') return quotation.status === 'pending';
                    if (this.quotationFilter === 'sent') return quotation.status === 'sent';
                    if (this.quotationFilter === 'accepted') return quotation.status === 'accepted';
                    if (this.quotationFilter === 'rejected') return quotation.status === 'rejected';
                    if (this.quotationFilter === 'expired') return quotation.status === 'expired';
                    return true;
                });
                
                const container = document.getElementById('quotations-list');
                
                if (filteredQuotations.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <p style="font-weight: 600;">No quotations found</p>
                            <p style="font-size: 14px; margin-top: 8px;">Create your first quotation to get started</p>
                        </div>`;
                    return;
                }
                
                const quotationsHTML = filteredQuotations.map(quotation => {
                    const customer = this.customers.find(c => c.id === quotation.customerId);
                    const customerName = customer ? customer.name : 'Unknown';
                    
                    const isExpired = new Date(quotation.validUntil) < new Date();
                    const actualStatus = isExpired && quotation.status !== 'accepted' ? 'expired' : quotation.status;
                    
                    const itemsPreview = quotation.items.slice(0, 2).map(item => 
                        `${item.vegeName}: ${item.quantity} ${item.unit}`
                    ).join('<br>');
                    
                    const moreItems = quotation.items.length > 2 ? 
                        `<br><small style="color: rgba(255,255,255,0.7);">+${quotation.items.length - 2} more items</small>` : '';
                    
                    return `
                        <div class="quotation-card" onclick="showQuotationDetails(${quotation.id})">
                            <span class="quotation-status status-${actualStatus}">
                                ${actualStatus}
                            </span>
                            <div class="item-header">
                                <div class="item-info">
                                    <h3>${customerName}</h3>
                                    <div class="item-meta">
                                        <span class="icon">üÜî</span>
                                        <span>${quotation.quotationNumber}</span>
                                    </div>
                                    <div class="item-meta">
                                        <span class="icon">üìÖ</span>
                                        <span>Valid until: ${new Date(quotation.validUntil).toLocaleDateString()}</span>
                                    </div>
                                    <div style="margin-top: 12px; font-size: 14px; line-height: 1.4;">
                                        ${itemsPreview}${moreItems}
                                    </div>
                                </div>
                            </div>
                            <div class="quotation-summary">
                                <div class="quotation-validity">
                                    Created: ${new Date(quotation.createdAt).toLocaleDateString()}
                                </div>
                                <div class="quotation-total">RM ${quotation.total.toFixed(2)}</div>
                            </div>
                        </div>`;
                }).join('');
                
                container.innerHTML = quotationsHTML;
            }
            
            setupCategoryFilters() {
                const categories = ['All', ...new Set(this.products.map(p => p.category).filter(Boolean))].sort();
                const container = document.getElementById('category-filters');
                
                const filtersHTML = categories.map((category, index) => `
                    <button class="category-btn ${index === 0 ? 'active' : ''}" 
                            onclick="filterByCategory('${category}')">
                        ${category}
                    </button>
                `).join('');
                
                container.innerHTML = filtersHTML;
            }
            
            // New: Setup quotation category filters
            setupQuotationCategoryFilters() {
                const categories = ['All', ...new Set(this.products.map(p => p.category).filter(Boolean))].sort();
                const container = document.getElementById('quotation-category-filters');
                
                const filtersHTML = categories.map((category, index) => `
                    <button class="category-btn ${index === 0 ? 'active' : ''}" 
                            onclick="filterQuotationByCategory('${category}')">
                        ${category}
                    </button>
                `).join('');
                
                container.innerHTML = filtersHTML;
            }
            
            handleCustomerSubmit(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('customer-name').value.trim(),
                    phone: document.getElementById('customer-phone').value.trim(),
                    address: document.getElementById('customer-address').value.trim(),
                    email: document.getElementById('customer-email').value.trim()
                };
                
                // Enhanced validation
                const errors = this.validateCustomerForm(formData);
                if (errors.length > 0) {
                    this.showFormErrors('customer', errors);
                    return;
                }
                
                // New: Check customer slot limit for new customers
                if (!this.editingCustomer && !this.canAddCustomer()) {
                    this.showCustomerSlotLimitReached();
                    this.showUpgradeDialog();
                    return;
                }
                
                if (this.editingCustomer) {
                    const index = this.customers.findIndex(c => c.id === this.editingCustomer.id);
                    this.customers[index] = { ...this.editingCustomer, ...formData };
                    this.showNotification('‚úÖ Customer updated successfully!', 'success');
                } else {
                    const newCustomer = { id: Date.now(), ...formData };
                    this.customers.push(newCustomer);
                    this.updateCustomerSlotUsage(); // New: Update slot usage
                    this.showNotification('‚úÖ Customer added successfully!', 'success');
                }
                
                this.closeCustomerForm();
                this.saveDataToStorage();
                this.updateStats();
                this.renderViews();
                this.populateQuotationCustomers(); // Update quotation customer dropdown
            }
            
            // New: Show upgrade dialog
            showUpgradeDialog() {
                // Create and show upgrade modal
                const upgradeModal = document.createElement('div');
                upgradeModal.className = 'modal show';
                upgradeModal.id = 'upgrade-modal';
                upgradeModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>üöÄ Upgrade Customer Slots</h3>
                            <button class="close-btn" onclick="closeUpgradeDialog()">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üìà</div>
                                <h4 style="color: #1f2937; margin-bottom: 8px;">You've reached your customer limit!</h4>
                                <p style="color: #6b7280;">Current: ${this.customers.length}/${this.customerSlots.total} customers</p>
                            </div>
                            
                            <div style="display: grid; gap: 16px; margin-bottom: 24px;">
                                <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 2px solid #0891b2; border-radius: 16px; padding: 20px;">
                                    <h4 style="color: #0c4a6e; margin-bottom: 12px;">üíé Premium Plan</h4>
                                    <div style="color: #0c4a6e; font-size: 32px; font-weight: 800; margin-bottom: 8px;">RM 99</div>
                                    <div style="color: #0369a1; margin-bottom: 16px;">100 Customer Slots</div>
                                    <ul style="color: #0369a1; font-size: 14px; margin-bottom: 16px; padding-left: 20px;">
                                        <li>Advanced analytics</li>
                                        <li>Priority support</li>
                                        <li>Export features</li>
                                        <li>Bulk operations</li>
                                    </ul>
                                    <button class="btn btn-primary" style="width: 100%;" onclick="purchasePremiumPlan()">
                                        Upgrade to Premium
                                    </button>
                                </div>
                                
                                <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border: 2px solid #8b5cf6; border-radius: 16px; padding: 20px;">
                                    <h4 style="color: #581c87; margin-bottom: 12px;">üì¶ Add-on Slots</h4>
                                    <div style="color: #581c87; font-size: 20px; font-weight: 700; margin-bottom: 8px;">RM 2.00 per slot</div>
                                    <div style="color: #7c3aed; margin-bottom: 16px;">Choose your quantity</div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
                                        <button class="btn btn-gray" style="padding: 12px 8px; font-size: 14px;" onclick="selectAddonSlots(50)">
                                            50 Slots<br><small>RM 100</small>
                                        </button>
                                        <button class="btn btn-purple" style="padding: 12px 8px; font-size: 14px;" onclick="selectAddonSlots(100)">
                                            100 Slots<br><small>RM 200</small>
                                        </button>
                                        <button class="btn btn-warning" style="padding: 12px 8px; font-size: 14px;" onclick="selectAddonSlots(200)">
                                            200 Slots<br><small>RM 400</small>
                                        </button>
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                        <input type="number" placeholder="Custom quantity" id="custom-slots" 
                                               style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px;"
                                               min="1" max="1000">
                                        <button class="btn btn-purple" onclick="selectCustomSlots()" style="padding: 12px 16px; font-size: 14px;">
                                            Add
                                        </button>
                                    </div>
                                    
                                    <div id="addon-selection" style="display: none;">
                                        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 1px solid #d1d5db;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                                <span style="color: #374151; font-weight: 600;">Selected:</span>
                                                <span id="selected-quantity" style="color: #1f2937; font-weight: 700;">0 slots</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="color: #374151; font-weight: 600;">Total:</span>
                                                <span id="selected-price" style="color: #1f2937; font-weight: 700; font-size: 18px;">RM 0.00</span>
                                            </div>
                                        </div>
                                        <button class="btn btn-success" style="width: 100%;" onclick="purchaseAddonSlots()">
                                            Purchase Add-on Slots
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px;">
                                <div style="font-size: 24px; margin-bottom: 8px;">üí≥</div>
                                <p style="color: #6b7280; font-size: 14px; margin: 0;">
                                    <strong>Secure Payment:</strong> All transactions are processed securely. 
                                    Instant activation upon payment confirmation.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(upgradeModal);
            }
            
            // New: Handle quotation submit
            handleQuotationSubmit(e) {
                e.preventDefault();
                
                const customerId = parseInt(document.getElementById('quotation-customer').value);
                const validityDays = parseInt(document.getElementById('quotation-validity').value) || 30;
                const terms = document.getElementById('quotation-terms').value.trim();
                
                if (!customerId) return;
                
                const quotationItems = [];
                this.products.forEach(product => {
                    const quantityInput = document.getElementById('quotation-quantity-' + product.id);
                    const priceInput = document.getElementById('quotation-price-' + product.id);
                    
                    if (quantityInput && priceInput) {
                        const quantity = parseFloat(quantityInput.value) || 0;
                        const price = parseFloat(priceInput.value) || product.price;
                        
                        if (quantity > 0) {
                            quotationItems.push({
                                vegeId: product.id,
                                vegeName: product.name,
                                unit: product.unit,
                                price: price,
                                quantity: quantity
                            });
                        }
                    }
                });
                
                if (quotationItems.length === 0) {
                    this.showNotification('‚ùå Please add at least one item to the quotation.', 'error');
                    return;
                }
                
                const total = quotationItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                const now = new Date();
                const validUntil = new Date(now.getTime() + (validityDays * 24 * 60 * 60 * 1000));
                
                const quotationNumber = this.generateQuotationNumber();
                
                const newQuotation = {
                    id: Date.now(),
                    customerId: customerId,
                    quotationNumber: quotationNumber,
                    date: now.toISOString().split('T')[0],
                    validUntil: validUntil.toISOString().split('T')[0],
                    status: 'pending',
                    items: quotationItems,
                    total: total,
                    terms: terms || this.companySettings.defaultTerms,
                    createdAt: now.toISOString(),
                    updatedAt: now.toISOString()
                };
                
                if (this.editingQuotation) {
                    const index = this.quotations.findIndex(q => q.id === this.editingQuotation.id);
                    this.quotations[index] = { ...this.editingQuotation, ...newQuotation, id: this.editingQuotation.id };
                    this.showNotification('‚úÖ Quotation updated successfully!', 'success');
                } else {
                    this.quotations.unshift(newQuotation);
                    this.showNotification('‚úÖ Quotation created successfully!', 'success');
                }
                
                this.closeQuotationForm();
                this.saveDataToStorage();
                this.updateStats();
                this.renderViews();
            }
            
            // New: Handle quotation settings submit
            handleQuotationSettingsSubmit(e) {
                e.preventDefault();
                
                this.companySettings.defaultValidityDays = parseInt(document.getElementById('default-validity').value) || 30;
                this.companySettings.defaultTerms = document.getElementById('default-terms').value.trim();
                this.companySettings.quotationPrefix = document.getElementById('quotation-prefix').value.trim() || 'QUO';
                
                this.saveDataToStorage();
                this.showNotification('üìã Quotation settings saved!', 'success');
            }
            
            // New: Generate quotation number
            generateQuotationNumber() {
                const prefix = this.companySettings.quotationPrefix || 'QUO';
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                
                // Find the next sequence number for today
                const today = now.toISOString().split('T')[0];
                const todayQuotations = this.quotations.filter(q => q.date === today);
                const sequence = String(todayQuotations.length + 1).padStart(3, '0');
                
                return `${prefix}-${year}${month}${day}-${sequence}`;
            }
            
            validateCustomerForm(formData) {
                const errors = [];
                
                if (!formData.name || formData.name.length < 2) {
                    errors.push({ field: 'name', message: 'Customer name must be at least 2 characters' });
                }
                
                if (formData.phone && !this.isValidMalaysianPhone(formData.phone)) {
                    errors.push({ field: 'phone', message: 'Please enter a valid Malaysian phone number' });
                }
                
                if (formData.email && !this.isValidEmail(formData.email)) {
                    errors.push({ field: 'email', message: 'Please enter a valid email address' });
                }
                
                return errors;
            }
            
            isValidMalaysianPhone(phone) {
                const patterns = [
                    /^(\+?6?0)(1[0-46-9])\d{7,8}$/, // Mobile
                    /^(\+?6?0)(3|4|5|6|7|8|9)\d{7,8}$/ // Landline
                ];
                return patterns.some(pattern => pattern.test(phone.replace(/[\s-]/g, '')));
            }
            
            isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }
            
            showFormErrors(formType, errors) {
                // Clear previous errors
                document.querySelectorAll('.form-error').forEach(el => {
                    el.classList.add('hidden');
                    el.textContent = '';
                });
                
                document.querySelectorAll('.form-input').forEach(el => {
                    el.classList.remove('error');
                });
                
                // Show new errors
                errors.forEach(error => {
                    const input = document.getElementById(`${formType}-${error.field}`);
                    const errorEl = document.getElementById(`${formType}-${error.field}-error`);
                    
                    if (input && errorEl) {
                        input.classList.add('error');
                        errorEl.textContent = error.message;
                        errorEl.classList.remove('hidden');
                    }
                });
            }
            
            handleCompanySubmit(e) {
                e.preventDefault();
                
                this.companySettings.name = document.getElementById('company-name').value.trim();
                this.companySettings.tagline = document.getElementById('company-tagline').value.trim();
                this.companySettings.phone = document.getElementById('company-phone').value.trim();
                this.companySettings.email = document.getElementById('company-email').value.trim();
                this.companySettings.website = document.getElementById('company-website').value.trim();
                this.companySettings.address = document.getElementById('company-address').value.trim();
                
                this.saveDataToStorage();
                this.showNotification('üè¢ Company settings saved!', 'success');
            }
            
            openCustomerForm() {
                this.editingCustomer = null;
                document.getElementById('customer-modal-title').textContent = 'Add Customer';
                document.getElementById('customer-form').reset();
                this.clearFormErrors();
                document.getElementById('customer-modal').classList.add('show');
            }
            
            closeCustomerForm() {
                document.getElementById('customer-modal').classList.remove('show');
                this.editingCustomer = null;
                this.clearFormErrors();
            }
            
            // New: Quotation form functions
            openQuotationForm() {
                this.editingQuotation = null;
                document.getElementById('quotation-modal-title').textContent = 'Create Quotation';
                document.getElementById('quotation-form').reset();
                document.getElementById('quotation-items').classList.add('hidden');
                
                // Set default values
                document.getElementById('quotation-validity').value = this.companySettings.defaultValidityDays || 30;
                document.getElementById('quotation-terms').value = this.companySettings.defaultTerms || '';
                
                this.populateQuotationCustomers();
                this.setupQuotationCategoryFilters();
                document.getElementById('quotation-modal').classList.add('show');
            }
            
            closeQuotationForm() {
                document.getElementById('quotation-modal').classList.remove('show');
                this.editingQuotation = null;
                this.clearQuotationQuantities();
            }
            
            // New: Populate quotation customers dropdown
            populateQuotationCustomers() {
                const select = document.getElementById('quotation-customer');
                const optionsHTML = '<option value="">Choose customer...</option>' +
                    this.customers.map(customer => 
                        `<option value="${customer.id}">${customer.name}</option>`
                    ).join('');
                select.innerHTML = optionsHTML;
            }
            
            // New: Initialize quotation items
            initializeQuotationItems() {
                this.renderQuotationItems('', 'all');
                document.getElementById('quotation-items').classList.remove('hidden');
                this.updateQuotationTotal();
            }
            
            // New: Render quotation items
            renderQuotationItems(searchTerm, category) {
                if (!category) category = this.selectedQuotationCategory;
                
                const container = document.getElementById('quotation-items-list');
                let itemsHTML = '';
                
                const filteredProducts = this.products.filter(product => {
                    const matchesSearch = !searchTerm || product.name.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesCategory = category === 'all' || (product.category && product.category.toLowerCase() === category);
                    return matchesSearch && matchesCategory;
                });
                
                filteredProducts.forEach(product => {
                    itemsHTML += `
                        <div class="quotation-item" id="quotation-item-${product.id}">
                            <div class="quotation-item-header">
                                <div class="quotation-item-name">${product.name}</div>
                                <button type="button" class="quotation-item-remove" onclick="removeQuotationItem(${product.id})">Remove</button>
                            </div>
                            <div class="quotation-item-details">
                                <div>
                                    <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">Quantity</label>
                                    <input type="number" step="0.1" min="0" placeholder="0" 
                                           style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px;"
                                           onchange="updateQuotationItemTotal(${product.id})" 
                                           oninput="updateQuotationItemTotal(${product.id})" 
                                           id="quotation-quantity-${product.id}">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">Price/Unit (RM)</label>
                                    <input type="number" step="0.01" min="0" placeholder="${product.price}" value="${product.price}"
                                           style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px;"
                                           onchange="updateQuotationItemTotal(${product.id})" 
                                           oninput="updateQuotationItemTotal(${product.id})" 
                                           id="quotation-price-${product.id}">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">Unit</label>
                                    <div style="padding: 8px; background: #f3f4f6; border-radius: 8px; font-size: 14px; text-align: center; color: #374151;">
                                        ${product.unit}
                                    </div>
                                </div>
                            </div>
                            <div class="quotation-item-total" id="quotation-item-total-${product.id}">RM 0.00</div>
                        </div>`;
                });
                
                container.innerHTML = itemsHTML;
            }
            
            clearFormErrors() {
                document.querySelectorAll('.form-error').forEach(el => {
                    el.classList.add('hidden');
                    el.textContent = '';
                });
                
                document.querySelectorAll('.form-input').forEach(el => {
                    el.classList.remove('error');
                });
            }
            
            // New: Clear quotation quantities
            clearQuotationQuantities() {
                this.products.forEach(product => {
                    const quantityInput = document.getElementById('quotation-quantity-' + product.id);
                    const priceInput = document.getElementById('quotation-price-' + product.id);
                    
                    if (quantityInput) quantityInput.value = '';
                    if (priceInput) priceInput.value = product.price;
                });
            }
            
            handleCustomerSearch(query) {
                if (!this.searchEngine) return;
                
                const results = this.searchEngine.search(query, 'customer', { limit: 5 });
                const resultsContainer = document.getElementById('customer-search-results');
                
                if (query.length < 2) {
                    resultsContainer.classList.add('hidden');
                    return;
                }
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item">No customers found</div>';
                } else {
                    const resultsHTML = results.map(result => `
                        <div class="search-result-item" onclick="selectCustomer(${result.id})">
                            <strong>${result.highlighted}</strong><br>
                            <small>${result.data.phone || 'No phone'}</small>
                        </div>
                    `).join('');
                    resultsContainer.innerHTML = resultsHTML;
                }
                
                resultsContainer.classList.remove('hidden');
            }
            
            handleProductSearch(query) {
                if (!this.searchEngine) return;
                
                const results = this.searchEngine.search(query, 'product', { limit: 5 });
                const resultsContainer = document.getElementById('product-search-results');
                
                if (query.length < 2) {
                    resultsContainer.classList.add('hidden');
                    return;
                }
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item">No products found</div>';
                } else {
                    const resultsHTML = results.map(result => `
                        <div class="search-result-item" onclick="selectProduct(${result.id})">
                            <strong>${result.highlighted}</strong><br>
                            <small>RM ${result.data.price} per ${result.data.unit}</small>
                        </div>
                    `).join('');
                    resultsContainer.innerHTML = resultsHTML;
                }
                
                resultsContainer.classList.remove('hidden');
            }
        }
        
        // Enhanced utility classes (same as before)
        class SearchEngine {
            constructor() {
                this.searchIndex = new Map();
            }
            
            search(query, type = null, options = {}) {
                const { limit = 10 } = options;
                if (!query || query.length < 2) return [];
                
                const searchTerms = query.toLowerCase().split(' ').filter(term => term.length > 0);
                const results = [];
                
                // Simple search implementation
                const items = type === 'customer' ? app.customers : 
                             type === 'product' ? app.products : 
                             [...app.customers, ...app.products];
                
                items.forEach(item => {
                    const searchableText = Object.values(item)
                        .filter(value => typeof value === 'string')
                        .join(' ').toLowerCase();
                    
                    let relevance = 0;
                    searchTerms.forEach(term => {
                        if (searchableText.includes(term)) {
                            relevance += 10;
                        }
                    });
                    
                    if (relevance > 0) {
                        results.push({
                            ...item,
                            relevance,
                            highlighted: this.highlightMatches(item.name, searchTerms)
                        });
                    }
                });
                
                return results.sort((a, b) => b.relevance - a.relevance).slice(0, limit);
            }
            
            highlightMatches(text, searchTerms) {
                let highlighted = text;
                searchTerms.forEach(term => {
                    const regex = new RegExp(`(${term})`, 'gi');
                    highlighted = highlighted.replace(regex, '<span class="search-highlight">$1</span>');
                });
                return highlighted;
            }
        }
        
        class BusinessAnalytics {
            generateDashboardData(days = 30) {
                const endDate = new Date();
                const startDate = new Date(endDate.getTime() - (days * 24 * 60 * 60 * 1000));
                
                const salesTrend = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateKey = d.toISOString().split('T')[0];
                    const dayOrders = app.orders.filter(order => order.date === dateKey);
                    const daySales = dayOrders.reduce((sum, order) => sum + order.total, 0);
                    
                    salesTrend.push({
                        date: dateKey,
                        sales: daySales
                    });
                }
                
                return {
                    salesTrend,
                    topProducts: this.getTopProducts(startDate, endDate),
                    topCustomers: this.getTopCustomers(startDate, endDate)
                };
            }
            
            getTopProducts(startDate, endDate) {
                const productSales = new Map();
                
                app.orders.forEach(order => {
                    const orderDate = new Date(order.createdAt);
                    if (orderDate >= startDate && orderDate <= endDate) {
                        order.items.forEach(item => {
                            const current = productSales.get(item.vegeId) || {
                                name: item.vegeName,
                                quantity: 0,
                                revenue: 0
                            };
                            current.quantity += item.quantity;
                            current.revenue += item.quantity * item.price;
                            productSales.set(item.vegeId, current);
                        });
                    }
                });
                
                return Array.from(productSales.entries())
                    .map(([id, data]) => ({ productId: id, ...data }))
                    .sort((a, b) => b.revenue - a.revenue)
                    .slice(0, 10);
            }
            
            getTopCustomers(startDate, endDate) {
                const customerData = new Map();
                
                app.orders.forEach(order => {
                    const orderDate = new Date(order.createdAt);
                    if (orderDate >= startDate && orderDate <= endDate) {
                        const current = customerData.get(order.customerId) || {
                            customerId: order.customerId,
                            totalSpent: 0,
                            orderCount: 0
                        };
                        current.totalSpent += order.total;
                        current.orderCount += 1;
                        customerData.set(order.customerId, current);
                    }
                });
                
                return Array.from(customerData.values())
                    .sort((a, b) => b.totalSpent - a.totalSpent)
                    .slice(0, 10);
            }
        }
        
        class NotificationManager {
            constructor() {
                this.permission = 'default';
            }
            
            async init() {
                if ('Notification' in window) {
                    this.permission = await Notification.requestPermission();
                }
            }
            
            showNotification(title, options = {}) {
                if (this.permission === 'granted') {
                    new Notification(title, {
                        icon: '/icon-192.png',
                        ...options
                    });
                }
            }
        }
        
        class InventoryManager {
            constructor() {
                this.inventory = new Map();
                this.lowStockThreshold = 10;
                this.initializeInventory();
            }
            
            initializeInventory() {
                app.products.forEach(product => {
                    this.inventory.set(product.id, {
                        productId: product.id,
                        currentStock: product.stock || 50,
                        lowStockThreshold: this.lowStockThreshold
                    });
                });
            }
            
            getLowStockItems() {
                const lowStockItems = [];
                
                for (const [productId, stockItem] of this.inventory) {
                    if (stockItem.currentStock <= stockItem.lowStockThreshold) {
                        const product = app.products.find(p => p.id === productId);
                        if (product) {
                            lowStockItems.push({
                                ...product,
                                currentStock: stockItem.currentStock
                            });
                        }
                    }
                }
                
                return lowStockItems;
            }
        }
        
        class VegeOrderStorage {
            async saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Storage error:', error);
                    return false;
                }
            }
            
            async loadData(key) {
                try {
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : null;
                } catch (error) {
                    console.error('Load error:', error);
                    return null;
                }
            }
        }
        
        // Global app instance and functions
        let app;
        
        // Global functions for onclick handlers
        function showView(viewName) {
            app.showView(viewName);
        }
        
        function openCustomerForm() {
            app.openCustomerForm();
        }
        
        function closeCustomerForm() {
            app.closeCustomerForm();
        }
        
        function editCustomer(id) {
            const customer = app.customers.find(c => c.id === id);
            if (customer) {
                app.editingCustomer = customer;
                document.getElementById('customer-modal-title').textContent = 'Edit Customer';
                document.getElementById('customer-name').value = customer.name;
                document.getElementById('customer-phone').value = customer.phone || '';
                document.getElementById('customer-address').value = customer.address || '';
                document.getElementById('customer-email').value = customer.email || '';
                document.getElementById('customer-modal').classList.add('show');
            }
        }
        
        function deleteCustomer(id) {
            if (confirm('Delete this customer? This will also delete all their orders and quotations.')) {
                app.customers = app.customers.filter(c => c.id !== id);
                app.orders = app.orders.filter(o => o.customerId !== id);
                app.quotations = app.quotations.filter(q => q.customerId !== id); // New
                app.saveDataToStorage();
                app.updateStats();
                app.renderViews();
                app.showNotification('üóëÔ∏è Customer deleted', 'success');
            }
        }
        
        function handleCustomerSearch(query) {
            app.handleCustomerSearch(query);
        }
        
        function handleProductSearch(query) {
            app.handleProductSearch(query);
        }
        
        function filterByCategory(category) {
            app.selectedCategory = category.toLowerCase();
            
            document.querySelectorAll('#category-filters .category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === category) {
                    btn.classList.add('active');
                }
            });
            
            app.renderProducts();
        }
        
        // New: Quotation functions
        function openQuotationForm() {
            app.openQuotationForm();
        }
        
        function closeQuotationForm() {
            app.closeQuotationForm();
        }
        
        function filterQuotations(status) {
            app.quotationFilter = status;
            
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === status) {
                    btn.classList.add('active');
                }
            });
            
            app.renderQuotations();
        }
        
        function filterQuotationItems(searchTerm) {
            app.renderQuotationItems(searchTerm, app.selectedQuotationCategory);
        }
        
        function filterQuotationByCategory(category) {
            app.selectedQuotationCategory = category.toLowerCase();
            
            document.querySelectorAll('#quotation-category-filters .category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === category) {
                    btn.classList.add('active');
                }
            });
            
            const searchTerm = document.getElementById('quotation-search').value;
            app.renderQuotationItems(searchTerm, app.selectedQuotationCategory);
        }
        
        function updateQuotationItemTotal(productId) {
            const quantityInput = document.getElementById('quotation-quantity-' + productId);
            const priceInput = document.getElementById('quotation-price-' + productId);
            const totalElement = document.getElementById('quotation-item-total-' + productId);
            
            if (quantityInput && priceInput && totalElement) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                
                totalElement.textContent = 'RM ' + total.toFixed(2);
            }
            
            updateQuotationTotal();
        }
        
        function updateQuotationTotal() {
            let total = 0;
            
            app.products.forEach(product => {
                const quantityInput = document.getElementById('quotation-quantity-' + product.id);
                const priceInput = document.getElementById('quotation-price-' + product.id);
                
                if (quantityInput && priceInput) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    total += quantity * price;
                }
            });
            
            document.getElementById('quotation-total').textContent = 'RM ' + total.toFixed(2);
        }
        
        function removeQuotationItem(productId) {
            const quantityInput = document.getElementById('quotation-quantity-' + productId);
            const priceInput = document.getElementById('quotation-price-' + productId);
            
            if (quantityInput) quantityInput.value = '';
            if (priceInput) {
                const product = app.products.find(p => p.id === productId);
                if (product) priceInput.value = product.price;
            }
            
            updateQuotationItemTotal(productId);
        }
        
        function showQuotationDetails(quotationId) {
            const quotation = app.quotations.find(q => q.id === quotationId);
            if (!quotation) return;
            
            app.currentQuotationDetails = quotation;
            const customer = app.customers.find(c => c.id === quotation.customerId);
            const customerName = customer ? customer.name : 'Unknown Customer';
            
            const isExpired = new Date(quotation.validUntil) < new Date();
            const actualStatus = isExpired && quotation.status !== 'accepted' ? 'expired' : quotation.status;
            
            let itemsHTML = '';
            quotation.items.forEach(item => {
                const itemTotal = item.quantity * item.price;
                itemsHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #1f2937; font-size: 16px;">${item.vegeName}</div>
                            <div style="font-size: 14px; color: #6b7280;">RM ${item.price.toFixed(2)} per ${item.unit}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: #1f2937; font-size: 16px;">${item.quantity} ${item.unit}</div>
                            <div style="font-size: 14px; color: #7c3aed; font-weight: 600;">RM ${itemTotal.toFixed(2)}</div>
                        </div>
                    </div>`;
            });
            
            const content = `
                <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #d1d5db;">
                    <h4 style="font-weight: 700; font-size: 20px; margin-bottom: 8px; color: #1f2937;">${customerName}</h4>
                    <p style="color: #6b7280; font-weight: 600;">${quotation.quotationNumber}</p>
                    <p style="color: #6b7280; font-size: 14px;">Created: ${new Date(quotation.createdAt).toLocaleDateString()}</p>
                    <p style="color: #6b7280; font-size: 14px;">Valid until: ${new Date(quotation.validUntil).toLocaleDateString()}</p>
                    <span class="quotation-status status-${actualStatus}" style="margin-top: 12px; display: inline-block;">
                        ${actualStatus}
                    </span>
                </div>
                
                <div class="share-buttons">
                    <button class="share-btn whatsapp" onclick="shareQuotationWhatsApp(${quotationId})">
                        <span>üí¨</span>
                        <span>WhatsApp</span>
                    </button>
                    <button class="share-btn email" onclick="shareQuotationEmail(${quotationId})">
                        <span>üìß</span>
                        <span>Email</span>
                    </button>
                    <button class="share-btn pdf" onclick="showQuotationDisplay(${quotationId})">
                        <span>üìÑ</span>
                        <span>View/PDF</span>
                    </button>
                </div>
                
                <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #d1d5db;">
                    <h4 style="font-weight: 700; margin-bottom: 16px; color: #1f2937; font-size: 18px;">Quoted Items</h4>
                    ${itemsHTML}
                </div>
                
                <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 20px; padding: 20px; border: 2px solid #c084fc; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <span style="font-weight: 700; font-size: 20px; color: #1f2937;">Total Amount:</span>
                        <span style="font-size: 28px; font-weight: 800; color: #7c3aed;">RM ${quotation.total.toFixed(2)}</span>
                    </div>
                    ${quotation.terms ? `
                        <div style="background: rgba(255,255,255,0.8); padding: 16px; border-radius: 12px; margin-top: 16px;">
                            <h5 style="font-weight: 700; margin-bottom: 8px; color: #1f2937;">Terms & Conditions:</h5>
                            <p style="color: #374151; font-size: 14px; line-height: 1.4;">${quotation.terms}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    ${quotation.status === 'pending' || quotation.status === 'sent' ? `
                        <button onclick="convertQuotationToOrder(${quotationId})" class="btn btn-success" style="font-weight: 700;">
                            ‚úÖ Convert to Order
                        </button>
                        <button onclick="markQuotationSent(${quotationId})" class="btn btn-primary" style="font-weight: 700;">
                            üì§ Mark as Sent
                        </button>
                    ` : ''}
                    <button onclick="editQuotation(${quotationId})" class="btn btn-warning" style="font-weight: 700;">
                        ‚úèÔ∏è Edit Quotation
                    </button>
                    <button onclick="deleteQuotation(${quotationId})" class="btn btn-danger" style="font-weight: 700;">
                        üóëÔ∏è Delete
                    </button>
                </div>`;
            
            document.getElementById('quotation-details-content').innerHTML = content;
            document.getElementById('quotation-details-modal').classList.add('show');
        }
        
        function closeQuotationDetails() {
            document.getElementById('quotation-details-modal').classList.remove('show');
            app.currentQuotationDetails = null;
        }
        
        function showQuotationDisplay(quotationId) {
            const quotation = app.quotations.find(q => q.id === quotationId);
            if (!quotation) return;
            
            app.currentQuotationDetails = quotation;
            const customer = app.customers.find(c => c.id === quotation.customerId);
            
            // Generate professional quotation display
            const businessName = app.companySettings.name || 'VegeOrder Pro';
            const businessTagline = app.companySettings.tagline || 'Professional Vegetable Supply & Order Management';
            const businessPhone = app.companySettings.phone || '+60 12-345-6789';
            const businessEmail = app.companySettings.email || 'info@vegeorder.my';
            const businessAddress = app.companySettings.address || '123 Jalan Pasar, Taman Sayur, 40000 Shah Alam, Selangor';
            
            let itemsHTML = '';
            quotation.items.forEach((item, index) => {
                const itemTotal = item.quantity * item.price;
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; font-weight: 600; color: #1f2937;">${index + 1}.</td>
                        <td style="padding: 12px; color: #1f2937;">${item.vegeName}</td>
                        <td style="padding: 12px; text-align: center; color: #1f2937;">${item.quantity}</td>
                        <td style="padding: 12px; text-align: center; color: #1f2937;">${item.unit}</td>
                        <td style="padding: 12px; text-align: right; color: #1f2937;">RM ${item.price.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 700; color: #1f2937;">RM ${itemTotal.toFixed(2)}</td>
                    </tr>`;
            });
            
            const quotationHTML = `
                <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #7c3aed; padding-bottom: 20px;">
                    <h1 style="font-size: 28px; font-weight: 800; color: #7c3aed; margin-bottom: 8px;">${businessName}</h1>
                    <div style="font-size: 16px; margin-bottom: 12px; color: #6b7280;">${businessTagline}</div>
                    <div style="font-size: 14px; color: #374151; line-height: 1.4;">
                        Phone: ${businessPhone} | Email: ${businessEmail}<br>
                        Address: ${businessAddress}
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h2 style="font-size: 24px; font-weight: 800; color: #1f2937; margin-bottom: 20px; text-align: center;">QUOTATION</h2>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border-left: 4px solid #7c3aed;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 12px;">QUOTATION DETAILS</h3>
                        <div style="margin-bottom: 6px;"><strong>Quotation No:</strong> ${quotation.quotationNumber}</div>
                        <div style="margin-bottom: 6px;"><strong>Date:</strong> ${new Date(quotation.date).toLocaleDateString()}</div>
                        <div style="margin-bottom: 6px;"><strong>Valid Until:</strong> ${new Date(quotation.validUntil).toLocaleDateString()}</div>
                        <div><strong>Status:</strong> <span style="text-transform: uppercase; font-weight: 700; color: #7c3aed;">${quotation.status}</span></div>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border-left: 4px solid #7c3aed;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 12px;">QUOTE TO</h3>
                        <div style="margin-bottom: 6px;"><strong>Customer:</strong> ${customer ? customer.name : 'Unknown'}</div>
                        <div style="margin-bottom: 6px;"><strong>Phone:</strong> ${customer ? customer.phone : 'N/A'}</div>
                        <div style="margin-bottom: 6px;"><strong>Email:</strong> ${customer ? customer.email : 'N/A'}</div>
                        <div><strong>Address:</strong> ${customer ? customer.address : 'N/A'}</div>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: #7c3aed; color: white;">
                            <th style="padding: 16px; text-align: left; font-weight: 700;">No.</th>
                            <th style="padding: 16px; text-align: left; font-weight: 700;">Item Description</th>
                            <th style="padding: 16px; text-align: center; font-weight: 700;">Qty</th>
                            <th style="padding: 16px; text-align: center; font-weight: 700;">Unit</th>
                            <th style="padding: 16px; text-align: right; font-weight: 700;">Unit Price</th>
                            <th style="padding: 16px; text-align: right; font-weight: 700;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>
                
                <div style="background: #faf5ff; padding: 24px; border-radius: 12px; border: 2px solid #c084fc; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 800; color: #7c3aed;">
                        <span>TOTAL QUOTED AMOUNT:</span>
                        <span>RM ${quotation.total.toFixed(2)}</span>
                    </div>
                </div>
                
                ${quotation.terms ? `
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                        <h4 style="font-weight: 700; margin-bottom: 12px; color: #1f2937;">Terms & Conditions:</h4>
                        <p style="color: #374151; line-height: 1.6; white-space: pre-line;">${quotation.terms}</p>
                    </div>
                ` : ''}
                
                <div style="text-align: center; padding: 20px; background: #f9fafb; border-radius: 12px; border-top: 3px solid #7c3aed; font-size: 12px; color: #6b7280;">
                    <div style="margin-bottom: 8px; font-weight: 600;">Thank you for considering our quotation!</div>
                    <div>This quotation is valid until ${new Date(quotation.validUntil).toLocaleDateString()} | All prices are in Malaysian Ringgit (RM)</div>
                    <div style="margin-top: 8px;">Generated on ${new Date().toLocaleString()} by ${businessName}</div>
                </div>`;
            
            document.getElementById('quotation-display-content').innerHTML = quotationHTML;
            document.getElementById('quotation-display-modal').classList.add('show');
            
            // Update action buttons based on status
            const convertBtn = document.getElementById('convert-to-order-btn');
            const markSentBtn = document.getElementById('mark-sent-btn');
            
            if (quotation.status === 'accepted') {
                convertBtn.style.display = 'block';
                markSentBtn.style.display = 'none';
            } else if (quotation.status === 'sent') {
                convertBtn.style.display = 'none';
                markSentBtn.textContent = '‚úÖ Mark as Accepted';
                markSentBtn.style.display = 'block';
            } else {
                convertBtn.style.display = 'none';
                markSentBtn.style.display = 'block';
            }
        }
        
        function closeQuotationDisplay() {
            document.getElementById('quotation-display-modal').classList.remove('show');
            app.currentQuotationDetails = null;
        }
        
        function shareQuotationWhatsApp(quotationId) {
            const quotation = quotationId ? app.quotations.find(q => q.id === quotationId) : app.currentQuotationDetails;
            if (!quotation) return;
            
            const customer = app.customers.find(c => c.id === quotation.customerId);
            const customerName = customer ? customer.name : 'Unknown Customer';
            
            const businessName = app.companySettings.name || 'VegeOrder Pro';
            const businessPhone = app.companySettings.phone || '+60 12-345-6789';
            const businessEmail = app.companySettings.email || 'info@vegeorder.my';
            
            let itemsList = '';
            quotation.items.forEach((item, index) => {
                const itemTotal = item.quantity * item.price;
                itemsList += `${index + 1}. ${item.vegeName}\n`;
                itemsList += `   ${item.quantity} ${item.unit} √ó RM${item.price.toFixed(2)} = RM${itemTotal.toFixed(2)}\n`;
            });
            
            const message = `üìã *${businessName} - QUOTATION*\n\n` +
                `üÜî *${quotation.quotationNumber}*\n` +
                `üë§ Customer: ${customerName}\n` +
                `üìÖ Date: ${new Date(quotation.date).toLocaleDateString()}\n` +
                `‚è∞ Valid Until: ${new Date(quotation.validUntil).toLocaleDateString()}\n\n` +
                `üì¶ *QUOTED ITEMS:*\n` +
                `${itemsList}\n` +
                `üí∞ *TOTAL QUOTED AMOUNT: RM${quotation.total.toFixed(2)}*\n\n` +
                `${quotation.terms ? `üìù Terms & Conditions:\n${quotation.terms}\n\n` : ''}` +
                `üè™ ${businessName}\n` +
                `üìû ${businessPhone}\n` +
                `üìß ${businessEmail}\n` +
                `üì± Professional Vegetable Supply Management`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            try {
                if (window.innerWidth <= 768) {
                    window.location.href = whatsappUrl;
                } else {
                    window.open(whatsappUrl, '_blank');
                }
            } catch (error) {
                navigator.clipboard.writeText(message).then(() => {
                    app.showNotification('üìã Quotation copied to clipboard!', 'success');
                });
            }
        }
        
        function shareQuotationEmail(quotationId) {
            const quotation = quotationId ? app.quotations.find(q => q.id === quotationId) : app.currentQuotationDetails;
            if (!quotation) return;
            
            const customer = app.customers.find(c => c.id === quotation.customerId);
            const customerName = customer ? customer.name : 'Unknown Customer';
            const businessName = app.companySettings.name || 'VegeOrder Pro';
            
            const subject = `${businessName} - Quotation ${quotation.quotationNumber} for ${customerName}`;
            const body = `Dear ${customerName},\n\nPlease find our quotation ${quotation.quotationNumber} for your vegetable requirements.\n\nQuotation Total: RM${quotation.total.toFixed(2)}\nValid Until: ${new Date(quotation.validUntil).toLocaleDateString()}\n\nThank you for your business.\n\nBest regards,\n${businessName}`;
            
            const mailtoUrl = `mailto:${customer ? customer.email : ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            try {
                window.location.href = mailtoUrl;
            } catch (error) {
                navigator.clipboard.writeText(body).then(() => {
                    app.showNotification('üìß Email content copied to clipboard!', 'success');
                });
            }
        }
        
        function generateQuotationPDF() {
            if (!app.currentQuotationDetails) return;
            
            app.showNotification('üìÑ PDF generation coming soon!', 'info');
        }
        
        function convertQuotationToOrder(quotationId) {
            const quotation = quotationId ? app.quotations.find(q => q.id === quotationId) : app.currentQuotationDetails;
            if (!quotation) return;
            
            if (confirm('Convert this quotation to an order?')) {
                const newOrder = {
                    id: Date.now(),
                    customerId: quotation.customerId,
                    date: new Date().toISOString().split('T')[0],
                    items: quotation.items.map(item => ({ ...item })),
                    total: quotation.total,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    quotationId: quotation.id
                };
                
                app.orders.unshift(newOrder);
                
                // Update quotation status
                const quotationIndex = app.quotations.findIndex(q => q.id === quotation.id);
                if (quotationIndex !== -1) {
                    app.quotations[quotationIndex].status = 'accepted';
                    app.quotations[quotationIndex].updatedAt = new Date().toISOString();
                }
                
                app.saveDataToStorage();
                app.updateStats();
                app.showNotification('‚úÖ Quotation converted to order successfully!', 'success');
                
                closeQuotationDetails();
                closeQuotationDisplay();
            }
        }
        
        function markQuotationSent(quotationId) {
            const quotation = quotationId ? app.quotations.find(q => q.id === quotationId) : app.currentQuotationDetails;
            if (!quotation) return;
            
            const quotationIndex = app.quotations.findIndex(q => q.id === quotation.id);
            if (quotationIndex !== -1) {
                const newStatus = quotation.status === 'sent' ? 'accepted' : 'sent';
                app.quotations[quotationIndex].status = newStatus;
                app.quotations[quotationIndex].updatedAt = new Date().toISOString();
                
                app.saveDataToStorage();
                app.updateStats();
                app.renderViews();
                
                const statusText = newStatus === 'sent' ? 'sent' : 'accepted';
                app.showNotification(`üì§ Quotation marked as ${statusText}!`, 'success');
                
                closeQuotationDetails();
                closeQuotationDisplay();
            }
        }
        
        function editQuotation(quotationId) {
            app.showNotification('‚úèÔ∏è Edit quotation coming soon!', 'info');
        }
        
        function deleteQuotation(quotationId) {
            if (confirm('Delete this quotation permanently?')) {
                app.quotations = app.quotations.filter(q => q.id !== quotationId);
                app.saveDataToStorage();
                app.updateStats();
                app.renderViews();
                app.showNotification('üóëÔ∏è Quotation deleted', 'success');
                
                closeQuotationDetails();
            }
        }
        
        // Existing functions remain the same
        function openOrderForm() {
            app.showNotification('üöÄ Order form coming soon!', 'info');
        }
        
        function openProductForm() {
            app.showNotification('üöÄ Product form coming soon!', 'info');
        }
        
        function editProduct(id) {
            app.showNotification('üöÄ Edit product coming soon!', 'info');
        }
        
        function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                app.products = app.products.filter(p => p.id !== id);
                app.saveDataToStorage();
                app.updateStats();
                app.renderViews();
                app.showNotification('üóëÔ∏è Product deleted', 'success');
            }
        }
        
        function showOrderDetails(id) {
            app.showNotification('üöÄ Order details coming soon!', 'info');
        }
        
        function openInventoryManager() {
            app.showNotification('üì¶ Inventory manager coming soon!', 'info');
        }
        
        function generateReport() {
            app.showNotification('üìä Report generator coming soon!', 'info');
        }
        
        function showAnalytics() {
            app.showNotification('üìà Detailed analytics coming soon!', 'info');
        }
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app = new VegeOrderApp();
            
            // Update time every minute
            setInterval(() => {
                app.updateStatusBar();
            }, 60000);
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.enhanced-search')) {
                    document.querySelectorAll('.search-results').forEach(el => {
                        el.classList.add('hidden');
                    });
                }
            });
            
            // Load settings values
            setTimeout(() => {
                if (app.companySettings.name) {
                    document.getElementById('company-name').value = app.companySettings.name;
                    document.getElementById('company-tagline').value = app.companySettings.tagline || '';
                    document.getElementById('company-phone').value = app.companySettings.phone || '';
                    document.getElementById('company-email').value = app.companySettings.email || '';
                    document.getElementById('company-website').value = app.companySettings.website || '';
                    document.getElementById('company-address').value = app.companySettings.address || '';
                }
                
                // Load quotation settings
                document.getElementById('default-validity').value = app.companySettings.defaultValidityDays || 30;
                document.getElementById('default-terms').value = app.companySettings.defaultTerms || '';
                document.getElementById('quotation-prefix').value = app.companySettings.quotationPrefix || 'QUO';
            }, 100);
        });
    </script>
</body>
</html>
