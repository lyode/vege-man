// Complete VegeOrder Pro JavaScript Implementation
// Enhanced Malaysian Vegetable Management System with Quotations

// Utility Classes
class SearchEngine {
    constructor() {
        this.searchIndex = new Map();
    }
    
    search(query, type = null, options = {}) {
        const { limit = 10 } = options;
        if (!query || query.length < 2) return [];
        
        const searchTerms = query.toLowerCase().split(' ').filter(term => term.length > 0);
        const results = [];
        
        const app = window.vegeOrderApp;
        if (!app) return [];
        
        let searchData = [];
        
        if (type === 'customer' || !type) {
            searchData = searchData.concat(app.customers.map(customer => ({
                id: customer.id,
                type: 'customer',
                searchText: `${customer.name} ${customer.phone} ${customer.address || ''} ${customer.email || ''}`.toLowerCase(),
                data: customer,
                name: customer.name
            })));
        }
        
        if (type === 'product' || !type) {
            searchData = searchData.concat(app.products.map(product => ({
                id: product.id,
                type: 'product',
                searchText: `${product.name} ${product.category || ''}`.toLowerCase(),
                data: product,
                name: product.name
            })));
        }
        
        if (type === 'order' || !type) {
            searchData = searchData.concat(app.orders.map(order => {
                const customer = app.customers.find(c => c.id === order.customerId);
                return {
                    id: order.id,
                    type: 'order',
                    searchText: `${customer?.name || ''} ${order.id}`.toLowerCase(),
                    data: order,
                    name: `Order #${order.id}`
                };
            }));
        }
        
        // Search and rank results
        searchData.forEach(item => {
            let score = 0;
            let highlighted = item.name;
            
            searchTerms.forEach(term => {
                if (item.searchText.includes(term)) {
                    score += 1;
                    if (item.name.toLowerCase().includes(term)) {
                        score += 2;
                        const regex = new RegExp(`(${term})`, 'gi');
                        highlighted = highlighted.replace(regex, '<span class="search-highlight">$1</span>');
                    }
                }
            });
            
            if (score > 0) {
                results.push({
                    ...item,
                    score,
                    highlighted
                });
            }
        });
        
        return results
            .sort((a, b) => b.score - a.score)
            .slice(0, limit);
    }
}

class BusinessAnalytics {
    constructor() {
        this.app = null;
    }
    
    setApp(app) {
        this.app = app;
    }
    
    generateDashboardData(days = 7) {
        if (!this.app) return { salesTrend: [], topProducts: [], insights: {} };
        
        const endDate = new Date();
        const startDate = new Date(endDate.getTime() - (days * 24 * 60 * 60 * 1000));
        
        const salesTrend = [];
        for (let i = 0; i < days; i++) {
            const currentDate = new Date(startDate.getTime() + (i * 24 * 60 * 60 * 1000));
            const dateStr = currentDate.toISOString().split('T')[0];
            
            const dayOrders = this.app.orders.filter(order => order.date === dateStr);
            const daySales = dayOrders.reduce((sum, order) => sum + order.total, 0);
            
            salesTrend.push({
                date: dateStr,
                sales: daySales,
                orders: dayOrders.length
            });
        }
        
        const productSales = new Map();
        this.app.orders.forEach(order => {
            order.items.forEach(item => {
                const current = productSales.get(item.vegeId) || { quantity: 0, revenue: 0, name: item.vegeName };
                productSales.set(item.vegeId, {
                    ...current,
                    quantity: current.quantity + item.quantity,
                    revenue: current.revenue + (item.quantity * item.price)
                });
            });
        });
        
        const topProducts = Array.from(productSales.entries())
            .map(([id, data]) => ({ id: parseInt(id), ...data }))
            .sort((a, b) => b.revenue - a.revenue)
            .slice(0, 5);
        
        const insights = {
            totalRevenue: salesTrend.reduce((sum, day) => sum + day.sales, 0),
            totalOrders: salesTrend.reduce((sum, day) => sum + day.orders, 0),
            avgOrderValue: salesTrend.length > 0 ? 
                salesTrend.reduce((sum, day) => sum + day.sales, 0) / Math.max(1, salesTrend.reduce((sum, day) => sum + day.orders, 0)) : 0,
            growthRate: this.calculateGrowthRate(salesTrend)
        };
        
        return { salesTrend, topProducts, insights };
    }
    
    calculateGrowthRate(salesTrend) {
        if (salesTrend.length < 2) return 0;
        
        const recentSales = salesTrend.slice(-3).reduce((sum, day) => sum + day.sales, 0);
        const previousSales = salesTrend.slice(-6, -3).reduce((sum, day) => sum + day.sales, 0);
        
        if (previousSales === 0) return 0;
        return ((recentSales - previousSales) / previousSales * 100);
    }
    
    getCustomerAnalytics() {
        if (!this.app) return [];
        
        const customerStats = this.app.customers.map(customer => {
            const customerOrders = this.app.orders.filter(order => order.customerId === customer.id);
            const customerQuotations = this.app.quotations.filter(q => q.customerId === customer.id);
            const totalSpent = customerOrders.reduce((sum, order) => sum + order.total, 0);
            const avgOrderValue = customerOrders.length > 0 ? totalSpent / customerOrders.length : 0;
            
            return {
                ...customer,
                totalOrders: customerOrders.length,
                totalQuotations: customerQuotations.length,
                totalSpent,
                avgOrderValue,
                lastOrderDate: customerOrders.length > 0 ? 
                    Math.max(...customerOrders.map(o => new Date(o.date).getTime())) : null
            };
        });
        
        return customerStats.sort((a, b) => b.totalSpent - a.totalSpent);
    }
}

class NotificationManager {
    constructor() {
        this.notifications = [];
        this.isSupported = 'Notification' in window;
    }
    
    async requestPermission() {
        if (!this.isSupported) return false;
        
        const permission = await Notification.requestPermission();
        return permission === 'granted';
    }
    
    showNotification(title, options = {}) {
        if (!this.isSupported) return;
        
        const defaultOptions = {
            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzEwYjk4MSIvPgo8dGV4dCB4PSIxNiIgeT0iMjIiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPvCfpbk8L3RleHQ+Cjwvc3ZnPg==',
            badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzEwYjk4MSIvPgo8dGV4dCB4PSIxNiIgeT0iMjIiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPvCfpbk8L3RleHQ+Cjwvc3ZnPg==',
            tag: 'vegeorder-notification',
            requireInteraction: false,
            ...options
        };
        
        try {
            const notification = new Notification(title, defaultOptions);
            this.notifications.push(notification);
            
            setTimeout(() => {
                notification.close();
            }, 5000);
            
            return notification;
        } catch (error) {
            console.error('Notification error:', error);
        }
    }
    
    showLowStockAlert(item) {
        this.showNotification(`Low Stock Alert: ${item.name}`, {
            body: `Only ${item.stock} ${item.unit} remaining`,
            icon: '⚠️',
            tag: 'low-stock-' + item.id
        });
    }
    
    showNewOrderAlert(order) {
        const customer = window.vegeOrderApp?.customers?.find(c => c.id === order.customerId);
        this.showNotification('New Order Received', {
            body: `${customer?.name || 'Customer'} - RM ${order.total.toFixed(2)}`,
            icon: '🛒',
            tag: 'new-order-' + order.id
        });
    }
}

class InventoryManager {
    constructor() {
        this.lowStockThreshold = 10;
        this.criticalStockThreshold = 5;
    }
    
    getLowStockItems() {
        const app = window.vegeOrderApp;
        if (!app) return [];
        
        return app.products.filter(product => {
            const stock = product.stock || 0;
            return stock <= this.lowStockThreshold && stock > 0;
        });
    }
    
    getCriticalStockItems() {
        const app = window.vegeOrderApp;
        if (!app) return [];
        
        return app.products.filter(product => {
            const stock = product.stock || 0;
            return stock <= this.criticalStockThreshold;
        });
    }
    
    updateStock(productId, newStock) {
        const app = window.vegeOrderApp;
        if (!app) return false;
        
        const product = app.products.find(p => p.id === productId);
        if (!product) return false;
        
        const oldStock = product.stock || 0;
        product.stock = newStock;
        
        if (newStock <= this.lowStockThreshold && oldStock > this.lowStockThreshold) {
            app.notificationManager?.showLowStockAlert(product);
        }
        
        app.saveDataToStorage();
        return true;
    }
    
    processOrderStock(orderItems) {
        const app = window.vegeOrderApp;
        if (!app) return false;
        
        for (const item of orderItems) {
            const product = app.products.find(p => p.id === item.vegeId);
            if (!product || (product.stock || 0) < item.quantity) {
                throw new Error(`Insufficient stock for ${item.vegeName}`);
            }
        }
        
        orderItems.forEach(item => {
            const product = app.products.find(p => p.id === item.vegeId);
            if (product) {
                product.stock = (product.stock || 0) - item.quantity;
            }
        });
        
        app.saveDataToStorage();
        return true;
    }
}

class VegeOrderStorage {
    constructor() {
        this.storagePrefix = 'vegeorder_';
        this.isAvailable = this.checkStorageAvailability();
    }
    
    checkStorageAvailability() {
        try {
            const test = '__storage_test__';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch (e) {
            return false;
        }
    }
    
    async saveData(key, data) {
        if (!this.isAvailable) {
            console.warn('LocalStorage not available');
            return false;
        }
        
        try {
            const serialized = JSON.stringify(data);
            localStorage.setItem(this.storagePrefix + key, serialized);
            return true;
        } catch (error) {
            console.error('Storage save error:', error);
            return false;
        }
    }
    
    async loadData(key) {
        if (!this.isAvailable) {
            return null;
        }
        
        try {
            const serialized = localStorage.getItem(this.storagePrefix + key);
            return serialized ? JSON.parse(serialized) : null;
        } catch (error) {
            console.error('Storage load error:', error);
            return null;
        }
    }
    
    async removeData(key) {
        if (!this.isAvailable) {
            return false;
        }
        
        try {
            localStorage.removeItem(this.storagePrefix + key);
            return true;
        } catch (error) {
            console.error('Storage remove error:', error);
            return false;
        }
    }
    
    async clearAll() {
        if (!this.isAvailable) {
            return false;
        }
        
        try {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith(this.storagePrefix)) {
                    localStorage.removeItem(key);
                }
            });
            return true;
        } catch (error) {
            console.error('Storage clear error:', error);
            return false;
        }
    }
    
    exportData() {
        const data = {
            customers: window.vegeOrderApp?.customers || [],
            products: window.vegeOrderApp?.products || [],
            orders: window.vegeOrderApp?.orders || [],
            quotations: window.vegeOrderApp?.quotations || [],
            settings: window.vegeOrderApp?.companySettings || {}
        };
        return JSON.stringify(data, null, 2);
    }
    
    importData(jsonData) {
        try {
            const data = JSON.parse(jsonData);
            if (data.customers) window.vegeOrderApp.customers = data.customers;
            if (data.products) window.vegeOrderApp.products = data.products;
            if (data.orders) window.vegeOrderApp.orders = data.orders;
            if (data.quotations) window.vegeOrderApp.quotations = data.quotations;
            if (data.settings) window.vegeOrderApp.companySettings = data.settings;
            
            window.vegeOrderApp.saveDataToStorage();
            return true;
        } catch (error) {
            console.error('Import error:', error);
            return false;
        }
    }
}

// Main Application Class - Complete Implementation
class VegeOrderApp {
    constructor() {
        this.currentView = 'dashboard';
        this.customers = [];
        this.products = [];
        this.orders = [];
        this.quotations = [];
        this.selectedDate = new Date().toISOString().split('T')[0];
        this.orderFilter = 'all';
        this.quotationFilter = 'all';
        this.editingCustomer = null;
        this.editingProduct = null;
        this.editingOrder = null;
        this.editingQuotation = null;
        this.selectedCategory = 'all';
        this.selectedQuotationCategory = 'all';
        this.isOnline = navigator.onLine;
        this.syncQueue = [];
        this.currentQuotationDetails = null;
        
        this.searchEngine = new SearchEngine();
        this.analytics = new BusinessAnalytics();
        this.notificationManager = new NotificationManager();
        this.inventoryManager = new InventoryManager();
        this.storage = new VegeOrderStorage();
        
        this.companySettings = {
            name: '',
            tagline: '',
            phone: '',
            email: '',
            website: '',
            address: '',
            invoicePrefix: 'INV',
            paymentTerms: 7,
            taxRate: 0,
            invoiceNotes: '',
            ownerName: '',
            ownerTitle: '',
            ownerPhone: '',
            ownerEmail: '',
            quotationPrefix: 'QUO',
            defaultValidityDays: 30,
            defaultTerms: 'This quotation is valid for 30 days from the date of issue. Prices are subject to change without notice. Payment terms: Net 30 days.'
        };
        
        this.init();
    }
    
    async init() {
        await this.loadDataFromStorage();
        this.setupEventListeners();
        this.setupConnectionHandling();
        this.updateStatusBar();
        this.updateCurrentDate();
        this.updateStats();
        this.updateAnalytics();
        this.renderViews();
        this.checkLowStock();
        this.setupNotifications();
        this.loadCompanySettings();
        
        this.preventZoom();
        this.setupTouchFeedback();
        this.setupPullToRefresh();
        
        console.log('🥬 VegeOrder Pro with Quotations initialized!');
    }
    
    async loadDataFromStorage() {
        try {
            const savedSettings = await this.storage.loadData('vegeorder_company_settings');
            if (savedSettings) {
                this.companySettings = { ...this.companySettings, ...savedSettings };
            }
            
            const savedCustomers = await this.storage.loadData('vegeorder_customers');
            if (savedCustomers) {
                this.customers = savedCustomers;
            }
            
            const savedProducts = await this.storage.loadData('vegeorder_products');
            if (savedProducts) {
                this.products = savedProducts;
            }
            
            const savedOrders = await this.storage.loadData('vegeorder_orders');
            if (savedOrders) {
                this.orders = savedOrders;
            }
            
            const savedQuotations = await this.storage.loadData('vegeorder_quotations');
            if (savedQuotations) {
                this.quotations = savedQuotations;
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }
        
        if (this.customers.length === 0) {
            this.loadInitialData();
        }
    }
    
    loadInitialData() {
        this.customers = [
            { id: 1, name: 'Restoran Ahmad Nasi Kandar', phone: '012-3456789', address: 'Jalan Sultan, KL', email: 'ahmad@nasikandar.com' },
            { id: 2, name: 'Siti Catering & Events', phone: '013-7654321', address: 'Taman Desa, PJ', email: 'siti@catering.my' },
            { id: 3, name: 'Lee Kitchen Chinese Restaurant', phone: '019-9876543', address: 'Chinatown, KL', email: 'lee@kitchen.com' },
            { id: 4, name: 'Warung Mak Cik Kiah', phone: '017-1234567', address: 'Kampung Baru, KL', email: 'kiah@warung.my' },
            { id: 5, name: 'Mamak Rashid 24 Jam', phone: '016-2345678', address: 'Shah Alam', email: 'rashid@mamak.my' },
            { id: 6, name: 'Restoran Sedap Rasa', phone: '014-3456789', address: 'Subang Jaya', email: 'sedap@restaurant.my' }
        ];
        
        this.products = [
            { id: 1, name: 'Kangkung 通菜 (Water Spinach)', unit: 'kg', price: 4.50, category: 'Leafy Greens', stock: 50 },
            { id: 2, name: 'Sawi Hijau 芥菜 (Chinese Mustard Green)', unit: 'kg', price: 5.00, category: 'Leafy Greens', stock: 30 },
            { id: 3, name: 'Sawi Putih 白菜 (Chinese Cabbage)', unit: 'kg', price: 4.80, category: 'Leafy Greens', stock: 25 },
            { id: 4, name: 'Spinach 菠菜 (Bayam Pasir)', unit: 'kg', price: 8.50, category: 'Leafy Greens', stock: 15 },
            { id: 5, name: 'Lettuce Iceberg 冰山生菜', unit: 'head', price: 4.50, category: 'Leafy Greens', stock: 20 },
            { id: 6, name: 'Pak Choy 白菜 (Bok Choy)', unit: 'kg', price: 5.50, category: 'Leafy Greens', stock: 35 },
            { id: 7, name: 'Kailan 芥兰 (Chinese Broccoli)', unit: 'kg', price: 7.00, category: 'Leafy Greens', stock: 28 },
            { id: 8, name: 'Petai 臭豆 (Stink Bean)', unit: 'kg', price: 18.00, category: 'Malaysian Specialty', stock: 12 },
            { id: 9, name: 'Jering 臭鳞豆', unit: 'kg', price: 15.00, category: 'Malaysian Specialty', stock: 8 },
            { id: 10, name: 'Rebung 竹笋 (Bamboo Shoots)', unit: 'kg', price: 8.50, category: 'Malaysian Specialty', stock: 22 },
            { id: 11, name: 'Labu Kuning 南瓜 (Pumpkin)', unit: 'kg', price: 3.20, category: 'Gourds & Squash', stock: 40 },
            { id: 12, name: 'Petola 丝瓜 (Luffa/Sponge Gourd)', unit: 'kg', price: 4.50, category: 'Gourds & Squash', stock: 18 },
            { id: 13, name: 'Peria 苦瓜 (Bitter Gourd)', unit: 'kg', price: 8.00, category: 'Gourds & Squash', stock: 16 },
            { id: 14, name: 'Timun 黄瓜 (Cucumber)', unit: 'kg', price: 3.80, category: 'Gourds & Squash', stock: 45 },
            { id: 15, name: 'Terung Ungu 紫茄子 (Purple Eggplant)', unit: 'kg', price: 5.50, category: 'Eggplants & Tomatoes', stock: 24 },
            { id: 16, name: 'Tomato Biasa 番茄 (Regular Tomato)', unit: 'kg', price: 6.00, category: 'Eggplants & Tomatoes', stock: 32 },
            { id: 17, name: 'Bendi 秋葵 (Okra/Ladies Finger)', unit: 'kg', price: 7.20, category: 'Beans & Pods', stock: 19 },
            { id: 18, name: 'Kacang Panjang 长豆 (Long Beans)', unit: 'kg', price: 6.50, category: 'Beans & Pods', stock: 38 },
            { id: 19, name: 'Taugeh 豆芽菜 (Bean Sprouts)', unit: 'kg', price: 3.50, category: 'Beans & Pods', stock: 60 },
            { id: 20, name: 'Bawang Merah 红葱头 (Shallots)', unit: 'kg', price: 8.00, category: 'Onions & Aromatics', stock: 25 },
            { id: 21, name: 'Bawang Putih 蒜头 (Garlic)', unit: 'kg', price: 18.00, category: 'Onions & Aromatics', stock: 15 },
            { id: 22, name: 'Bawang Besar Merah 红洋葱 (Red Onions)', unit: 'kg', price: 5.00, category: 'Onions & Aromatics', stock: 30 },
            { id: 23, name: 'Cili Merah 红辣椒 (Red Chili)', unit: 'kg', price: 15.00, category: 'Peppers & Chilies', stock: 12 },
            { id: 24, name: 'Cili Padi 小辣椒 (Bird Eye Chili)', unit: 'kg', price: 25.00, category: 'Peppers & Chilies', stock: 6 },
            { id: 25, name: 'Capsicum Merah 红甜椒 (Red Bell Pepper)', unit: 'kg', price: 14.00, category: 'Peppers & Chilies', stock: 14 },
            { id: 26, name: 'Lobak Merah 胡萝卜 (Carrots)', unit: 'kg', price: 5.20, category: 'Root Vegetables', stock: 42 },
            { id: 27, name: 'Kentang 马铃薯 (Potato)', unit: 'kg', price: 4.00, category: 'Root Vegetables', stock: 55 },
            { id: 28, name: 'Ubi Kentang Merah 红薯 (Red Sweet Potato)', unit: 'kg', price: 4.20, category: 'Root Vegetables', stock: 33 }
        ];
        
        this.orders = [];
        
        this.quotations = [
            {
                id: 1,
                customerId: 1,
                quotationNumber: 'QUO-20250121-001',
                date: new Date().toISOString().split('T')[0],
                validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                status: 'sent',
                items: [
                    { vegeId: 1, vegeName: 'Kangkung 通菜 (Water Spinach)', unit: 'kg', price: 4.50, quantity: 10 },
                    { vegeId: 2, vegeName: 'Sawi Hijau 芥菜 (Chinese Mustard Green)', unit: 'kg', price: 5.00, quantity: 5 }
                ],
                total: 70.00,
                terms: 'This quotation is valid for 30 days from the date of issue. Prices are subject to change without notice.',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            }
        ];
        
        this.saveDataToStorage();
    }
    
    saveDataToStorage() {
        this.storage.saveData('vegeorder_company_settings', this.companySettings);
        this.storage.saveData('vegeorder_customers', this.customers);
        this.storage.saveData('vegeorder_products', this.products);
        this.storage.saveData('vegeorder_orders', this.orders);
        this.storage.saveData('vegeorder_quotations', this.quotations);
    }
    
    setupEventListeners() {
        document.getElementById('order-date').value = this.selectedDate;
        document.getElementById('order-date').addEventListener('change', (e) => {
            this.selectedDate = e.target.value;
            this.renderOrders();
            this.updateStats();
        });
        
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                const parent = btn.closest('.view');
                parent.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.orderFilter = btn.dataset.filter;
                this.renderOrders();
            });
        });
        
        document.getElementById('customer-form').addEventListener('submit', (e) => this.handleCustomerSubmit(e));
        document.getElementById('company-form').addEventListener('submit', (e) => this.handleCompanySubmit(e));
        document.getElementById('quotation-form').addEventListener('submit', (e) => this.handleQuotationSubmit(e));
        document.getElementById('quotation-settings-form').addEventListener('submit', (e) => this.handleQuotationSettingsSubmit(e));
        
        document.getElementById('quotation-customer').addEventListener('change', () => {
            if (document.getElementById('quotation-customer').value) {
                this.initializeQuotationItems();
            } else {
                document.getElementById('quotation-items').classList.add('hidden');
            }
        });
        
        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });
    }
    
    setupConnectionHandling() {
        const statusIndicator = document.getElementById('connection-status');
        
        const updateConnectionStatus = () => {
            this.isOnline = navigator.onLine;
            statusIndicator.className = `connection-status ${this.isOnline ? '' : 'offline'}`;
            
            if (this.isOnline) {
                this.syncPendingData();
                this.showNotification('🌐 Back online!', 'success');
            } else {
                this.showNotification('📴 Offline mode', 'warning');
            }
        };
        
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        updateConnectionStatus();
    }
    
    updateStatusBar() {
        const now = new Date();
        const timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
        document.getElementById('status-time').textContent = timeStr;
    }
    
    updateCurrentDate() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-MY', { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        });
        document.getElementById('current-date').textContent = dateStr;
    }
    
    updateStats() {
        const todayOrders = this.orders.filter(order => order.date === this.selectedDate);
        const totalSales = todayOrders.reduce((sum, order) => sum + order.total, 0);
        const pendingQuotations = this.quotations.filter(q => q.status === 'pending' || q.status === 'sent').length;
        
        document.getElementById('customers-count').textContent = this.customers.length;
        document.getElementById('products-count').textContent = this.products.length;
        document.getElementById('orders-count').textContent = todayOrders.length;
        document.getElementById('quotations-count').textContent = this.quotations.length;
        document.getElementById('daily-sales').textContent = 'RM ' + totalSales.toFixed(2);
        
        this.updateNavigationBadges();
    }
    
    updateNavigationBadges() {
        const pendingOrders = this.orders.filter(order => order.status === 'pending').length;
        const lowStockItems = this.inventoryManager ? this.inventoryManager.getLowStockItems().length : 0;
        const pendingQuotations = this.quotations.filter(q => q.status === 'pending' || q.status === 'sent').length;
        
        const pendingOrdersBadge = document.getElementById('pending-orders-badge');
        const lowStockBadge = document.getElementById('low-stock-badge');
        const pendingQuotesBadge = document.getElementById('pending-quotes-badge');
        
        if (pendingOrders > 0) {
            pendingOrdersBadge.textContent = pendingOrders;
            pendingOrdersBadge.classList.remove('hidden');
        } else {
            pendingOrdersBadge.classList.add('hidden');
        }
        
        if (lowStockItems > 0) {
            lowStockBadge.textContent = lowStockItems;
            lowStockBadge.classList.remove('hidden');
        } else {
            lowStockBadge.classList.add('hidden');
        }
        
        if (pendingQuotations > 0) {
            pendingQuotesBadge.textContent = pendingQuotations;
            pendingQuotesBadge.classList.remove('hidden');
        } else {
            pendingQuotesBadge.classList.add('hidden');
        }
    }
    
    updateAnalytics() {
        const analytics = this.analytics.generateDashboardData(7);
        const avgOrderValue = analytics.salesTrend.length > 0 ? 
            analytics.salesTrend.reduce((sum, day) => sum + day.sales, 0) / analytics.salesTrend.length : 0;
        
        document.getElementById('avg-order-value').textContent = 'RM ' + avgOrderValue.toFixed(0);
        
        if (analytics.topProducts.length > 0) {
            const topProduct = analytics.topProducts[0];
            const productName = topProduct.name.split(' ')[0];
            document.getElementById('top-product').textContent = productName;
        }
        
        const currentWeekSales = analytics.salesTrend.slice(-7).reduce((sum, day) => sum + day.sales, 0);
        const previousWeekSales = analytics.salesTrend.slice(-14, -7).reduce((sum, day) => sum + day.sales, 0);
        const growthRate = previousWeekSales > 0 ? 
            ((currentWeekSales - previousWeekSales) / previousWeekSales * 100).toFixed(1) : 0;
        
        document.getElementById('growth-rate').textContent = growthRate + '%';
        document.getElementById('total-customers').textContent = this.customers.length;
    }
    
    checkLowStock() {
        if (!this.inventoryManager) return;
        
        const lowStockItems = this.inventoryManager.getLowStockItems();
        const alertsContainer = document.getElementById('low-stock-alerts');
        
        if (lowStockItems.length > 0) {
            const alertsHTML = lowStockItems.map(item => `
                <div class="low-stock-alert">
                    <div class="icon">⚠️</div>
                    <div class="low-stock-content">
                        <h4>Low Stock Alert</h4>
                        <p>${item.name} - Only ${item.stock} ${item.unit} remaining</p>
                    </div>
                </div>
            `).join('');
            
            alertsContainer.innerHTML = alertsHTML;
        } else {
            alertsContainer.innerHTML = '';
        }
    }
    
    setupNotifications() {
        if ('Notification' in window && 'serviceWorker' in navigator) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('✅ Notifications enabled');
                }
            });
        }
    }
    
    loadCompanySettings() {
        if (this.companySettings.name) {
            document.getElementById('company-name').value = this.companySettings.name;
        }
        if (this.companySettings.tagline) {
            document.getElementById('company-tagline').value = this.companySettings.tagline;
        }
        if (this.companySettings.phone) {
            document.getElementById('company-phone').value = this.companySettings.phone;
        }
        if (this.companySettings.email) {
            document.getElementById('company-email').value = this.companySettings.email;
        }
        if (this.companySettings.website) {
            document.getElementById('company-website').value = this.companySettings.website;
        }
        if (this.companySettings.address) {
            document.getElementById('company-address').value = this.companySettings.address;
        }
        if (this.companySettings.defaultValidityDays) {
            document.getElementById('default-validity').value = this.companySettings.defaultValidityDays;
        }
        if (this.companySettings.defaultTerms) {
            document.getElementById('default-terms').value = this.companySettings.defaultTerms;
        }
        if (this.companySettings.quotationPrefix) {
            document.getElementById('quotation-prefix').value = this.companySettings.quotationPrefix;
        }
    }
    
    showNotification(text, type = 'success', icon = '✅') {
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationText = document.getElementById('notification-text');
        
        notification.className = `notification ${type}`;
        
        const icons = {
            success: '✅',
            error: '❌',
            warning: '⚠️',
            info: 'ℹ️'
        };
        
        notificationIcon.textContent = icons[type] || icon;
        notificationText.textContent = text;
        
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    syncPendingData() {
        if (this.syncQueue.length > 0 && this.isOnline) {
            console.log(`🔄 Syncing ${this.syncQueue.length} pending changes...`);
            this.syncQueue = [];
        }
    }
    
    preventZoom() {
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', () => {
                input.style.fontSize = '16px';
            });
        });
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    }
    
    setupTouchFeedback() {
        document.addEventListener('touchstart', (e) => {
            const target = e.target;
            if (target.matches('button, .nav-item, .item-card, .action-btn, .icon-btn, .category-btn, .stat-card, .quotation-card')) {
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            }
        }, {passive: true});
    }
    
    setupPullToRefresh() {
        const mainContent = document.getElementById('main-content');
        let startY = 0;
        let isPulling = false;
        
        mainContent.addEventListener('touchstart', (e) => {
            if (mainContent.scrollTop === 0) {
                startY = e.touches[0].clientY;
                isPulling = true;
            }
        }, {passive: true});
        
        mainContent.addEventListener('touchend', () => {
            if (isPulling) {
                this.updateStats();
                this.updateAnalytics();
                this.renderViews();
                this.showNotification('🔄 Data refreshed', 'success');
                isPulling = false;
            }
        }, {passive: true});
    }
    
    showView(viewName) {
        document.querySelectorAll('.view').forEach(view => {
            view.classList.add('hidden');
        });
        
        document.getElementById(viewName + '-view').classList.remove('hidden');
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        document.querySelectorAll('.nav-item').forEach(item => {
            const onclick = item.getAttribute('onclick');
            if (onclick && onclick.includes(viewName)) {
                item.classList.add('active');
            }
        });
        
        this.currentView = viewName;
        this.renderViews();
        
        document.getElementById('main-content').scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    
    renderViews() {
        switch (this.currentView) {
            case 'dashboard':
                this.renderRecentActivity();
                break;
            case 'customers':
                this.renderCustomers();
                break;
            case 'products':
                this.setupCategoryFilters();
                this.renderProducts();
                break;
            case 'orders':
                this.renderOrders();
                break;
            case 'quotations':
                this.renderQuotations();
                break;
        }
    }
    
    renderRecentActivity() {
        const todayOrders = this.orders.filter(order => order.date === this.selectedDate);
        const recentQuotations = this.quotations.slice(-3);
        const container = document.getElementById('recent-activity');
        
        if (todayOrders.length === 0 && recentQuotations.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">⏰</div>
                    <p style="font-weight: 600;">No recent activity</p>
                    <p style="font-size: 14px; margin-top: 8px;">Create your first order or quotation to get started</p>
                </div>`;
            return;
        }
        
        let activityHTML = '';
        
        recentQuotations.forEach(quotation => {
            const customer = this.customers.find(c => c.id === quotation.customerId);
            const customerName = customer ? customer.name : 'Unknown';
            
            activityHTML += `
                <div class="item-card" onclick="showQuotationDetails(${quotation.id})">
                    <div class="item-header">
                        <div class="item-info">
                            <h3>📋 ${customerName}</h3>
                            <div class="item-meta">
                                <span class="icon">🆔</span>
                                <span>${quotation.quotationNumber}</span>
                            </div>
                            <div class="item-meta">
                                <span class="icon">🕐</span>
                                <span>${new Date(quotation.createdAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 700; color: #7c3aed; margin-bottom: 8px;">
                                RM ${quotation.total.toFixed(2)}
                            </div>
                            <span class="quotation-status status-${quotation.status}">
                                ${quotation.status}
                            </span>
                        </div>
                    </div>
                </div>`;
        });
        
        const displayCount = Math.min(todayOrders.length, 2);
        todayOrders.slice(0, displayCount).forEach(order => {
            const customer = this.customers.find(c => c.id === order.customerId);
            const customerName = customer ? customer.name : 'Unknown';
            
            activityHTML += `
                <div class="item-card" onclick="showOrderDetails(${order.id})">
                    <div class="item-header">
                        <div class="item-info">
                            <h3>🛒 ${customerName}</h3>
                            <div class="item-meta">
                                <span class="icon">📦</span>
                                <span>${order.items.length} items</span>
                            </div>
                            <div class="item-meta">
                                <span class="icon">🕐</span>
                                <span>${new Date(order.createdAt).toLocaleTimeString()}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 700; color: #22d3ee; margin-bottom: 8px;">
                                RM ${order.total.toFixed(2)}
                            </div>
                            <span class="category-btn ${order.status === 'completed' ? 'active' : ''}" style="font-size: 11px; padding: 4px 8px;">
                                ${order.status}
                            </span>
                        </div>
                    </div>
                </div>`;
        });
        
        container.innerHTML = activityHTML;
    }
    
    renderCustomers() {
        const container = document.getElementById('customers-list');
        
        if (this.customers.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">👥</div>
                    <p style="font-weight: 600;">No customers yet</p>
                    <p style="font-size: 14px; margin-top: 8px;">Add your first customer to get started</p>
                </div>`;
            return;
        }
        
        const customersHTML = this.customers.map(customer => {
            const customerOrders = this.orders.filter(order => order.customerId === customer.id);
            const customerQuotations = this.quotations.filter(quotation => quotation.customerId === customer.id);
            const customerTotal = customerOrders.reduce((sum, order) => sum + order.total, 0);
            
            return `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-info">
                            <h3>${customer.name}</h3>
                            <div class="item-meta">
                                <span class="icon">📞</span>
                                <span>${customer.phone}</span>
                            </div>
                            ${customer.address ? `
                                <div class="item-meta">
                                    <span class="icon">📍</span>
                                    <span>${customer.address}</span>
                                </div>
                            ` : ''}
                            ${customer.email ? `
                                <div class="item-meta">
                                    <span class="icon">📧</span>
                                    <span>${customer.email}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="icon-btn primary" onclick="editCustomer(${customer.id})">✏️</button>
                            <button class="icon-btn danger" onclick="deleteCustomer(${customer.id})">🗑️</button>
                        </div>
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; display: flex; justify-content: space-between; font-size: 14px;">
                        <span style="color: rgba(255,255,255,0.8);">${customerOrders.length} orders • ${customerQuotations.length} quotes</span>
                        <span style="font-weight: 700; color: #22d3ee;">RM ${customerTotal.toFixed(2)}</span>
                    </div>
                </div>`;
        }).join('');
        
        container.innerHTML = customersHTML;
    }
    
    renderProducts() {
        const container = document.getElementById('products-list');
        
        let filteredProducts = this.products;
        if (this.selectedCategory !== 'all') {
            filteredProducts = this.products.filter(product => 
                product.category && product.category.toLowerCase() === this.selectedCategory
            );
        }
        
        if (filteredProducts.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">🥬</div>
                    <p style="font-weight: 600;">No products found</p>
                    <p style="font-size: 14px; margin-top: 8px;">Try adjusting your filter or add new products</p>
                </div>`;
            return;
        }
        
        const productsHTML = filteredProducts.map(product => {
            const stockLevel = product.stock || 0;
            const stockColor = stockLevel < 10 ? '#ef4444' : stockLevel < 20 ? '#f59e0b' : '#22c55e';
            
            return `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-info">
                            <h3>${product.name}</h3>
                            <div class="item-meta">
                                <span class="icon">💰</span>
                                <span>RM ${product.price.toFixed(2)} per ${product.unit}</span>
                            </div>
                            <div class="item-meta">
                                <span class="icon">📦</span>
                                <span style="color: ${stockColor};">Stock: ${stockLevel} ${product.unit}</span>
                            </div>
                            ${product.category ? `
                                <span class="category-btn" style="font-size: 11px; padding: 4px 8px; margin-top: 8px;">
                                    ${product.category}
                                </span>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="icon-btn primary" onclick="editProduct(${product.id})">✏️</button>
                            <button class="icon-btn danger" onclick="deleteProduct(${product.id})">🗑️</button>
                        </div>
                    </div>
                </div>`;
        }).join('');
        
        container.innerHTML = productsHTML;
    }
    
    renderOrders() {
        const todayOrders = this.orders.filter(order => order.date === this.selectedDate);
        const filteredOrders = todayOrders.filter(order => {
            if (this.orderFilter === 'pending') return order.status === 'pending';
            if (this.orderFilter === 'completed') return order.status === 'completed';
            return true;
        });
        
        const container = document.getElementById('orders-list');
        
        if (filteredOrders.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">🛒</div>
                    <p style="font-weight: 600;">No orders found</p>
                    <p style="font-size: 14px; margin-top: 8px;">Create your first order to get started</p>
                </div>`;
            return;
        }
        
        const ordersHTML = filteredOrders.map(order => {
            const customer = this.customers.find(c => c.id === order.customerId);
            const customerName = customer ? customer.name : 'Unknown';
            
            const itemsPreview = order.items.slice(0, 2).map(item => 
                `${item.vegeName}: ${item.quantity} ${item.unit}`
            ).join('<br>');
            
            const moreItems = order.items.length > 2 ? 
                `<br><small style="color: rgba(255,255,255,0.7);">+${order.items.length - 2} more items</small>` : '';
            
            return `
                <div class="item-card" onclick="showOrderDetails(${order.id})">
                    <div class="item-header">
                        <div class="item-info">
                            <h3>${customerName}</h3>
                            <div class="item-meta">
                                <span class="icon">🆔</span>
                                <span>#${order.id}</span>
                            </div>
                            <div class="item-meta">
                                <span class="icon">🕐</span>
                                <span>${new Date(order.createdAt).toLocaleString()}</span>
                            </div>
                            <div style="margin-top: 12px; font-size: 14px; line-height: 1.4;">
                                ${itemsPreview}${moreItems}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span class="category-btn ${order.status === 'completed' ? 'active' : ''}" style="font-size: 11px; padding: 4px 8px; margin-bottom: 8px;">
                                ${order.status}
                            </span>
                            <div style="font-size: 20px; font-weight: 700; color: #22d3ee;">
                                RM ${order.total.toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');
        
        container.innerHTML = ordersHTML;
    }
    
    renderQuotations() {
        let filteredQuotations = this.quotations;
        
        if (this.quotationFilter !== 'all') {
            filteredQuotations = this.quotations.filter(quotation => {
                const isExpired = new Date(quotation.validUntil) < new Date();
                const actualStatus = isExpired && quotation.status !== 'accepted' ? 'expired' : quotation.status;
                return actualStatus === this.quotationFilter;
            });
        }
        
        const container = document.getElementById('quotations-list');
        
        if (filteredQuotations.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">📋</div>
                    <p style="font-weight: 600;">No quotations found</p>
                    <p style="font-size: 14px; margin-top: 8px;">Create your first quotation to get started</p>
                </div>`;
            return;
        }
        
        const quotationsHTML = filteredQuotations.map(quotation => {
            const customer = this.customers.find(c => c.id === quotation.customerId);
            const customerName = customer ? customer.name : 'Unknown';
            
            const isExpired = new Date(quotation.validUntil) < new Date();
            const actualStatus = isExpired && quotation.status !== 'accepted' ? 'expired' : quotation.status;
            
            const itemsPreview = quotation.items.slice(0, 2).map(item => 
                `${item.vegeName}: ${item.quantity} ${item.unit}`
            ).join('<br>');
            
            const moreItems = quotation.items.length > 2 ? 
                `<br><small style="color: rgba(255,255,255,0.7);">+${quotation.items.length - 2} more items</small>` : '';
            
            return `
                <div class="quotation-card" onclick="showQuotationDetails(${quotation.id})">
                    <span class="quotation-status status-${actualStatus}">
                        ${actualStatus}
                    </span>
                    <div class="item-header">
                        <div class="item-info">
                            <h3>${customerName}</h3>
                            <div class="item-meta">
                                <span class="icon">🆔</span>
                                <span>${quotation.quotationNumber}</span>
                            </div>
                            <div class="item-meta">
                                <span class="icon">📅</span>
                                <span>Valid until: ${new Date(quotation.validUntil).toLocaleDateString()}</span>
                            </div>
                            <div style="margin-top: 12px; font-size: 14px; line-height: 1.4;">
                                ${itemsPreview}${moreItems}
                            </div>
                        </div>
                    </div>
                    <div class="quotation-summary">
                        <div class="quotation-validity">
                            Created: ${new Date(quotation.createdAt).toLocaleDateString()}
                        </div>
                        <div class="quotation-total">RM ${quotation.total.toFixed(2)}</div>
                    </div>
                </div>`;
        }).join('');
        
        container.innerHTML = quotationsHTML;
    }
    
    setupCategoryFilters() {
        const categories = ['All', ...new Set(this.products.map(p => p.category).filter(Boolean))].sort();
        const container = document.getElementById('category-filters');
        
        const filtersHTML = categories.map((category, index) => `
            <button class="category-btn ${index === 0 ? 'active' : ''}" 
                    onclick="filterByCategory('${category}')">
                ${category}
            </button>
        `).join('');
        
        container.innerHTML = filtersHTML;
    }
    
    setupQuotationCategoryFilters() {
        const categories = ['All', ...new Set(this.products.map(p => p.category).filter(Boolean))].sort();
        const container = document.getElementById('quotation-category-filters');
        
        const filtersHTML = categories.map((category, index) => `
            <button class="category-btn ${index === 0 ? 'active' : ''}" 
                    onclick="filterQuotationByCategory('${category}')">
                ${category}
            </button>
        `).join('');
        
        container.innerHTML = filtersHTML;
    }
    
    handleCustomerSubmit(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('customer-name').value.trim(),
            phone: document.getElementById('customer-phone').value.trim(),
            address: document.getElementById('customer-address').value.trim(),
            email: document.getElementById('customer-email').value.trim()
        };
        
        const errors = this.validateCustomerForm(formData);
        if (errors.length > 0) {
            this.showFormErrors('customer', errors);
            return;
        }
        
        if (this.editingCustomer) {
            const index = this.customers.findIndex(c => c.id === this.editingCustomer.id);
            this.customers[index] = { ...this.editingCustomer, ...formData };
            this.showNotification('✅ Customer updated successfully!', 'success');
        } else {
            const newCustomer = { id: Date.now(), ...formData };
            this.customers.push(newCustomer);
            this.showNotification('✅ Customer added successfully!', 'success');
        }
        
        this.closeCustomerForm();
        this.saveDataToStorage();
        this.updateStats();
        this.renderViews();
        this.populateQuotationCustomers();
    }
    
    handleQuotationSubmit(e) {
        e.preventDefault();
        
        const customerId = parseInt(document.getElementById('quotation-customer').value);
        const validityDays = parseInt(document.getElementById('quotation-validity').value) || 30;
        const terms = document.getElementById('quotation-terms').value.trim();
        
        if (!customerId) return;
        
        const quotationItems = [];
        this.products.forEach(product => {
            const quantityInput = document.getElementById('quotation-quantity-' + product.id);
            const priceInput = document.getElementById('quotation-price-' + product.id);
            
            if (quantityInput && priceInput) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || product.price;
                
                if (quantity > 0) {
                    quotationItems.push({
                        vegeId: product.id,
                        vegeName: product.name,
                        unit: product.unit,
                        price: price,
                        quantity: quantity
                    });
                }
            }
        });
        
        if (quotationItems.length === 0) {
            this.showNotification('❌ Please add at least one item to the quotation.', 'error');
            return;
        }
        
        const total = quotationItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
        const now = new Date();
        const validUntil = new Date(now.getTime() + (validityDays * 24 * 60 * 60 * 1000));
        
        const quotationNumber = this.generateQuotationNumber();
        
        const newQuotation = {
            id: Date.now(),
            customerId: customerId,
            quotationNumber: quotationNumber,
            date: now.toISOString().split('T')[0],
            validUntil: validUntil.toISOString().split('T')[0],
            status: 'pending',
            items: quotationItems,
            total: total,
            terms: terms || this.companySettings.defaultTerms,
            createdAt: now.toISOString(),
            updatedAt: now.toISOString()
        };
        
        if (this.editingQuotation) {
            const index = this.quotations.findIndex(q => q.id === this.editingQuotation.id);
            this.quotations[index] = { ...this.editingQuotation, ...newQuotation, id: this.editingQuotation.id };
            this.showNotification('✅ Quotation updated successfully!', 'success');
        } else {
            this.quotations.unshift(newQuotation);
            this.showNotification('✅ Quotation created successfully!', 'success');
        }
        
        this.closeQuotationForm();
        this.saveDataToStorage();
        this.updateStats();
        this.renderViews();
    }
    
    handleQuotationSettingsSubmit(e) {
        e.preventDefault();
        
        this.companySettings.defaultValidityDays = parseInt(document.getElementById('default-validity').value) || 30;
        this.companySettings.defaultTerms = document.getElementById('default-terms').value.trim();
        this.companySettings.quotationPrefix = document.getElementById('quotation-prefix').value.trim() || 'QUO';
        
        this.saveDataToStorage();
        this.showNotification('📋 Quotation settings saved!', 'success');
    }
    
    handleCompanySubmit(e) {
        e.preventDefault();
        
        this.companySettings.name = document.getElementById('company-name').value.trim();
        this.companySettings.tagline = document.getElementById('company-tagline').value.trim();
        this.companySettings.phone = document.getElementById('company-phone').value.trim();
        this.companySettings.email = document.getElementById('company-email').value.trim();
        this.companySettings.website = document.getElementById('company-website').value.trim();
        this.companySettings.address = document.getElementById('company-address').value.trim();
        
        this.saveDataToStorage();
        this.showNotification('🏢 Company settings saved!', 'success');
    }
    
    generateQuotationNumber() {
        const prefix = this.companySettings.quotationPrefix || 'QUO';
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        
        const today = now.toISOString().split('T')[0];
        const todayQuotations = this.quotations.filter(q => q.date === today);
        const sequence = String(todayQuotations.length + 1).padStart(3, '0');
        
        return `${prefix}-${year}${month}${day}-${sequence}`;
    }
    
    validateCustomerForm(formData) {
        const errors = [];
        
        if (!formData.name || formData.name.length < 2) {
            errors.push({ field: 'name', message: 'Customer name must be at least 2 characters' });
        }
        
        if (formData.phone && !this.isValidMalaysianPhone(formData.phone)) {
            errors.push({ field: 'phone', message: 'Please enter a valid Malaysian phone number' });
        }
        
        if (formData.email && !this.isValidEmail(formData.email)) {
            errors.push({ field: 'email', message: 'Please enter a valid email address' });
        }
        
        return errors;
    }
    
    isValidMalaysianPhone(phone) {
        const patterns = [
            /^(\+?6?0)(1[0-46-9])\d{7,8}$/,
            /^(\+?6?0)(3|4|5|6|7|8|9)\d{7,8}$/
        ];
        return patterns.some(pattern => pattern.test(phone.replace(/[\s-]/g, '')));
    }
    
    isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    
    showFormErrors(formType, errors) {
        document.querySelectorAll('.form-error').forEach(el => {
            el.classList.add('hidden');
            el.textContent = '';
        });
        
        document.querySelectorAll('.form-input').forEach(el => {
            el.classList.remove('error');
        });
        
        errors.forEach(error => {
            const input = document.getElementById(`${formType}-${error.field}`);
            const errorEl = document.getElementById(`${formType}-${error.field}-error`);
            
            if (input && errorEl) {
                input.classList.add('error');
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            }
        });
    }
    
    openCustomerForm() {
        this.editingCustomer = null;
        document.getElementById('customer-modal-title').textContent = 'Add Customer';
        document.getElementById('customer-form').reset();
        this.clearFormErrors();
        document.getElementById('customer-modal').classList.add('show');
    }
    
    closeCustomerForm() {
        document.getElementById('customer-modal').classList.remove('show');
        this.editingCustomer = null;
        this.clearFormErrors();
    }
    
    openQuotationForm() {
        this.editingQuotation = null;
        document.getElementById('quotation-modal-title').textContent = 'Create Quotation';
        document.getElementById('quotation-form').reset();
        document.getElementById('quotation-items').classList.add('hidden');
        
        document.getElementById('quotation-validity').value = this.companySettings.defaultValidityDays || 30;
        document.getElementById('quotation-terms').value = this.companySettings.defaultTerms || '';
        
        this.populateQuotationCustomers();
        this.setupQuotationCategoryFilters();
        document.getElementById('quotation-modal').classList.add('show');
    }
    
    closeQuotationForm() {
        document.getElementById('quotation-modal').classList.remove('show');
        this.editingQuotation = null;
        this.clearQuotationQuantities();
    }
    
    populateQuotationCustomers() {
        const select = document.getElementById('quotation-customer');
        const optionsHTML = '<option value="">Choose customer...</option>' +
            this.customers.map(customer => 
                `<option value="${customer.id}">${customer.name}</option>`
            ).join('');
        select.innerHTML = optionsHTML;
    }
    
    initializeQuotationItems() {
        this.renderQuotationItems('', 'all');
        document.getElementById('quotation-items').classList.remove('hidden');
        this.updateQuotationTotal();
    }
    
    renderQuotationItems(searchTerm, category) {
        if (!category) category = this.selectedQuotationCategory;
        
        const container = document.getElementById('quotation-items-list');
        let itemsHTML = '';
        
        const filteredProducts = this.products.filter(product => {
            const matchesSearch = !searchTerm || product.name.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesCategory = category === 'all' || (product.category && product.category.toLowerCase() === category);
            return matchesSearch && matchesCategory;
        });
        
        filteredProducts.forEach(product => {
            itemsHTML += `
                <div class="quotation-item" id="quotation-item-${product.id}">
                    <div class="quotation-item-header">
                        <div class="quotation-item-name">${product.name}</div>
                        <button type="button" class="quotation-item-remove" onclick="removeQuotationItem(${product.id})">Remove</button>
                    </div>
                    <div class="quotation-item-details">
                        <div>
                            <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">Quantity</label>
                            <input type="number" step="0.1" min="0" placeholder="0" 
                                   style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px;"
                                   onchange="updateQuotationItemTotal(${product.id})" 
                                   oninput="updateQuotationItemTotal(${product.id})" 
                                   id="quotation-quantity-${product.id}">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">Price/Unit (RM)</label>
                            <input type="number" step="0.01" min="0" placeholder="${product.price}" value="${product.price}"
                                   style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px;"
                                   onchange="updateQuotationItemTotal(${product.id})" 
                                   oninput="updateQuotationItemTotal(${product.id})" 
                                   id="quotation-price-${product.id}">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">Unit</label>
                            <div style="padding: 8px; background: #f3f4f6; border-radius: 8px; font-size: 14px; text-align: center; color: #374151;">
                                ${product.unit}
                            </div>
                        </div>
                    </div>
                    <div class="quotation-item-total" id="quotation-item-total-${product.id}">RM 0.00</div>
                </div>`;
        });
        
        container.innerHTML = itemsHTML;
    }
    
    updateQuotationTotal() {
        let total = 0;
        this.products.forEach(product => {
            const quantityInput = document.getElementById('quotation-quantity-' + product.id);
            const priceInput = document.getElementById('quotation-price-' + product.id);
            
            if (quantityInput && priceInput) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                total += quantity * price;
            }
        });
        
        document.getElementById('quotation-total').textContent = 'RM ' + total.toFixed(2);
    }
    
    clearFormErrors() {
        document.querySelectorAll('.form-error').forEach(el => {
            el.classList.add('hidden');
            el.textContent = '';
        });
        
        document.querySelectorAll('.form-input').forEach(el => {
            el.classList.remove('error');
        });
    }
    
    clearQuotationQuantities() {
        this.products.forEach(product => {
            const quantityInput = document.getElementById('quotation-quantity-' + product.id);
            const priceInput = document.getElementById('quotation-price-' + product.id);
            
            if (quantityInput) quantityInput.value = '';
            if (priceInput) priceInput.value = product.price;
        });
    }
    
    handleCustomerSearch(query) {
        if (!this.searchEngine) return;
        
        const results = this.searchEngine.search(query, 'customer', { limit: 5 });
        const resultsContainer = document.getElementById('customer-search-results');
        
        if (query.length < 2) {
            resultsContainer.classList.add('hidden');
            return;
        }
        
        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="search-result-item">No customers found</div>';
        } else {
            const resultsHTML = results.map(result => `
                <div class="search-result-item" onclick="selectCustomer(${result.id})">
                    <strong>${result.highlighted}</strong><br>
                    <small>${result.data.phone || 'No phone'}</small>
                </div>
            `).join('');
            resultsContainer.innerHTML = resultsHTML;
        }
        
        resultsContainer.classList.remove('hidden');
    }
    
    handleProductSearch(query) {
        if (!this.searchEngine) return;
        
        const results = this.searchEngine.search(query, 'product', { limit: 5 });
        const resultsContainer = document.getElementById('product-search-results');
        
        if (query.length < 2) {
            resultsContainer.classList.add('hidden');
            return;
        }
        
        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="search-result-item">No products found</div>';
        } else {
            const resultsHTML = results.map(result => `
                <div class="search-result-item" onclick="selectProduct(${result.id})">
                    <strong>${result.highlighted}</strong><br>
                    <small>RM ${result.data.price} per ${result.data.unit}</small>
                </div>
            `).join('');
            resultsContainer.innerHTML = resultsHTML;
        }
        
        resultsContainer.classList.remove('hidden');
    }
}

// Global Functions for UI Interactions
function showView(viewName) {
    window.vegeOrderApp.showView(viewName);
}

function editCustomer(id) {
    const customer = window.vegeOrderApp.customers.find(c => c.id === id);
    if (!customer) return;
    
    window.vegeOrderApp.editingCustomer = customer;
    document.getElementById('customer-modal-title').textContent = 'Edit Customer';
    
    document.getElementById('customer-name').value = customer.name || '';
    document.getElementById('customer-phone').value = customer.phone || '';
    document.getElementById('customer-address').value = customer.address || '';
    document.getElementById('customer-email').value = customer.email || '';
    
    document.getElementById('customer-modal').classList.add('show');
}

function deleteCustomer(id) {
    if (!confirm('Are you sure you want to delete this customer?')) return;
    
    const index = window.vegeOrderApp.customers.findIndex(c => c.id === id);
    if (index > -1) {
        window.vegeOrderApp.customers.splice(index, 1);
        window.vegeOrderApp.saveDataToStorage();
        window.vegeOrderApp.updateStats();
        window.vegeOrderApp.renderViews();
        window.vegeOrderApp.showNotification('Customer deleted', 'success');
    }
}

function editProduct(id) {
    window.vegeOrderApp.showNotification('📝 Product editing feature coming soon!', 'info');
}

function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    
    const index = window.vegeOrderApp.products.findIndex(p => p.id === id);
    if (index > -1) {
        window.vegeOrderApp.products.splice(index, 1);
        window.vegeOrderApp.saveDataToStorage();
        window.vegeOrderApp.updateStats();
        window.vegeOrderApp.renderViews();
        window.vegeOrderApp.showNotification('Product deleted', 'success');
    }
}

function filterByCategory(category) {
    document.querySelectorAll('#category-filters .category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    window.vegeOrderApp.selectedCategory = category.toLowerCase();
    window.vegeOrderApp.renderProducts();
}

function filterQuotationByCategory(category) {
    document.querySelectorAll('#quotation-category-filters .category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    window.vegeOrderApp.selectedQuotationCategory = category.toLowerCase();
    window.vegeOrderApp.renderQuotationItems(document.getElementById('quotation-search').value, category.toLowerCase());
}

function filterQuotations(status) {
    window.vegeOrderApp.quotationFilter = status;
    window.vegeOrderApp.renderQuotations();
}

function filterQuotationItems(searchTerm) {
    window.vegeOrderApp.renderQuotationItems(searchTerm, window.vegeOrderApp.selectedQuotationCategory);
}

function updateQuotationItemTotal(productId) {
    const quantityInput = document.getElementById('quotation-quantity-' + productId);
    const priceInput = document.getElementById('quotation-price-' + productId);
    const totalElement = document.getElementById('quotation-item-total-' + productId);
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const total = quantity * price;
    
    totalElement.textContent = 'RM ' + total.toFixed(2);
    
    window.vegeOrderApp.updateQuotationTotal();
}

function removeQuotationItem(productId) {
    const quantityInput = document.getElementById('quotation-quantity-' + productId);
    const priceInput = document.getElementById('quotation-price-' + productId);
    
    if (quantityInput) quantityInput.value = '';
    if (priceInput) {
        const product = window.vegeOrderApp.products.find(p => p.id === productId);
        priceInput.value = product ? product.price : '';
    }
    
    updateQuotationItemTotal(productId);
}

function openCustomerForm() {
    window.vegeOrderApp.openCustomerForm();
}

function closeCustomerForm() {
    window.vegeOrderApp.closeCustomerForm();
}

function openQuotationForm() {
    window.vegeOrderApp.openQuotationForm();
}

function closeQuotationForm() {
    window.vegeOrderApp.closeQuotationForm();
}

function openOrderForm() {
    window.vegeOrderApp.showNotification('🛒 Order form feature coming soon!', 'info');
}

function openProductForm() {
    window.vegeOrderApp.showNotification('🥬 Product form feature coming soon!', 'info');
}

function openInventoryManager() {
    window.vegeOrderApp.showNotification('📦 Inventory manager coming soon!', 'info');
}

function showQuotationDetails(quotationId) {
    const quotation = window.vegeOrderApp.quotations.find(q => q.id === quotationId);
    if (!quotation) return;
    
    window.vegeOrderApp.currentQuotationDetails = quotation;
    
    const customer = window.vegeOrderApp.customers.find(c => c.id === quotation.customerId);
    const company = window.vegeOrderApp.companySettings;
    
    const quotationHTML = `
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-size: 32px; font-weight: 800; color: #1f2937; margin-bottom: 8px;">
                ${company.name || 'VegeOrder Pro'}
            </h1>
            ${company.tagline ? `<p style="color: #6b7280; font-size: 16px;">${company.tagline}</p>` : ''}
            <div style="background: #10b981; height: 4px; width: 100px; margin: 20px auto; border-radius: 2px;"></div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
            <div>
                <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 16px;">Bill To:</h3>
                <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
                    <p style="font-weight: 700; font-size: 18px; color: #1f2937; margin-bottom: 8px;">${customer?.name || 'Unknown Customer'}</p>
                    ${customer?.address ? `<p style="color: #6b7280; margin-bottom: 4px;">${customer.address}</p>` : ''}
                    ${customer?.phone ? `<p style="color: #6b7280; margin-bottom: 4px;">Tel: ${customer.phone}</p>` : ''}
                    ${customer?.email ? `<p style="color: #6b7280;">${customer.email}</p>` : ''}
                </div>
            </div>
            <div>
                <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 16px;">Quotation Details:</h3>
                <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border-left: 4px solid #7c3aed;">
                    <p style="margin-bottom: 8px;"><strong>Quotation #:</strong> ${quotation.quotationNumber}</p>
                    <p style="margin-bottom: 8px;"><strong>Date:</strong> ${new Date(quotation.date).toLocaleDateString()}</p>
                    <p style="margin-bottom: 8px;"><strong>Valid Until:</strong> ${new Date(quotation.validUntil).toLocaleDateString()}</p>
                    <p><strong>Status:</strong> <span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; text-transform: uppercase;">${quotation.status}</span></p>
                </div>
            </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 40px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <thead>
                <tr style="background: #1f2937; color: white;">
                    <th style="padding: 16px; text-align: left; font-weight: 700;">Item Description</th>
                    <th style="padding: 16px; text-align: center; font-weight: 700;">Unit</th>
                    <th style="padding: 16px; text-align: center; font-weight: 700;">Quantity</th>
                    <th style="padding: 16px; text-align: right; font-weight: 700;">Unit Price (RM)</th>
                    <th style="padding: 16px; text-align: right; font-weight: 700;">Total (RM)</th>
                </tr>
            </thead>
            <tbody>
                ${quotation.items.map((item, index) => `
                    <tr style="border-bottom: 1px solid #e5e7eb; ${index % 2 === 0 ? 'background: #f9fafb;' : 'background: white;'}">
                        <td style="padding: 16px; font-weight: 600; color: #1f2937;">${item.vegeName}</td>
                        <td style="padding: 16px; text-align: center; color: #6b7280;">${item.unit}</td>
                        <td style="padding: 16px; text-align: center; font-weight: 600; color: #1f2937;">${item.quantity}</td>
                        <td style="padding: 16px; text-align: right; color: #6b7280;">${item.price.toFixed(2)}</td>
                        <td style="padding: 16px; text-align: right; font-weight: 700; color: #10b981;">${(item.quantity * item.price).toFixed(2)}</td>
                    </tr>
                `).join('')}
            </tbody>
            <tfoot>
                <tr style="background: #1f2937; color: white;">
                    <td colspan="4" style="padding: 20px; text-align: right; font-weight: 700; font-size: 18px;">TOTAL AMOUNT:</td>
                    <td style="padding: 20px; text-align: right; font-weight: 800; font-size: 24px; color: #22d3ee;">RM ${quotation.total.toFixed(2)}</td>
                </tr>
            </tfoot>
        </table>
        
        ${quotation.terms ? `
            <div style="background: #f3f4f6; padding: 24px; border-radius: 12px; border-left: 4px solid #6b7280;">
                <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 12px;">Terms & Conditions</h3>
                <p style="color: #4b5563; line-height: 1.6; white-space: pre-wrap;">${quotation.terms}</p>
            </div>
        ` : ''}
        
        <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
            <p style="color: #6b7280; font-size: 14px;">Thank you for your business!</p>
            ${company.website ? `<p style="color: #10b981; font-weight: 600; margin-top: 8px;">${company.website}</p>` : ''}
        </div>
    `;
    
    document.getElementById('quotation-display-content').innerHTML = quotationHTML;
    document.getElementById('quotation-display-modal').classList.add('show');
    
    const convertBtn = document.getElementById('convert-to-order-btn');
    const markSentBtn = document.getElementById('mark-sent-btn');
    
    convertBtn.style.display = quotation.status === 'accepted' ? 'block' : 'none';
    markSentBtn.style.display = quotation.status === 'pending' ? 'block' : 'none';
}

function showOrderDetails(orderId) {
    window.vegeOrderApp.showNotification('📋 Order details feature coming soon!', 'info');
}

function closeQuotationDetails() {
    document.getElementById('quotation-details-modal').classList.remove('show');
}

function closeQuotationDisplay() {
    document.getElementById('quotation-display-modal').classList.remove('show');
    window.vegeOrderApp.currentQuotationDetails = null;
}

function shareQuotationWhatsApp() {
    const quotation = window.vegeOrderApp.currentQuotationDetails;
    if (!quotation) return;
    
    const customer = window.vegeOrderApp.customers.find(c => c.id === quotation.customerId);
    const message = `Hello ${customer?.name || 'Customer'},\n\nPlease find your quotation details:\n\n📋 Quotation #: ${quotation.quotationNumber}\n💰 Total: RM ${quotation.total.toFixed(2)}\n📅 Valid until: ${new Date(quotation.validUntil).toLocaleDateString()}\n\nThank you for your interest!\n\n${window.vegeOrderApp.companySettings.name || 'VegeOrder Pro'}`;
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

function shareQuotationEmail() {
    const quotation = window.vegeOrderApp.currentQuotationDetails;
    if (!quotation) return;
    
    const customer = window.vegeOrderApp.customers.find(c => c.id === quotation.customerId);
    const subject = `Quotation ${quotation.quotationNumber} - ${window.vegeOrderApp.companySettings.name || 'VegeOrder Pro'}`;
    const body = `Dear ${customer?.name || 'Customer'},\n\nPlease find attached your quotation details:\n\nQuotation #: ${quotation.quotationNumber}\nTotal Amount: RM ${quotation.total.toFixed(2)}\nValid Until: ${new Date(quotation.validUntil).toLocaleDateString()}\n\nThank you for your business!\n\nBest regards,\n${window.vegeOrderApp.companySettings.name || 'VegeOrder Pro'}`;
    
    const emailUrl = `mailto:${customer?.email || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = emailUrl;
}

function generateQuotationPDF() {
    window.vegeOrderApp.showNotification('📄 PDF generation feature coming soon!', 'info');
}

function convertQuotationToOrder() {
    const quotation = window.vegeOrderApp.currentQuotationDetails;
    if (!quotation) return;
    
    if (!confirm('Convert this quotation to an order?')) return;
    
    const newOrder = {
        id: Date.now(),
        customerId: quotation.customerId,
        date: new Date().toISOString().split('T')[0],
        items: quotation.items,
        total: quotation.total,
        status: 'pending',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        fromQuotation: quotation.id
    };
    
    quotation.status = 'accepted';
    quotation.updatedAt = new Date().toISOString();
    
    window.vegeOrderApp.orders.unshift(newOrder);
    window.vegeOrderApp.saveDataToStorage();
    window.vegeOrderApp.updateStats();
    window.vegeOrderApp.showNotification('✅ Order created from quotation!', 'success');
    
    closeQuotationDisplay();
}

function markQuotationSent() {
    const quotation = window.vegeOrderApp.currentQuotationDetails;
    if (!quotation) return;
    
    quotation.status = 'sent';
    quotation.updatedAt = new Date().toISOString();
    
    window.vegeOrderApp.saveDataToStorage();
    window.vegeOrderApp.updateStats();
    window.vegeOrderApp.renderViews();
    window.vegeOrderApp.showNotification('📤 Quotation marked as sent!', 'success');
    
    closeQuotationDisplay();
}

function handleCustomerSearch(query) {
    window.vegeOrderApp.handleCustomerSearch(query);
}

function handleProductSearch(query) {
    window.vegeOrderApp.handleProductSearch(query);
}

function selectCustomer(id) {
    document.getElementById('customer-search-results').classList.add('hidden');
    window.vegeOrderApp.showNotification('Customer selected', 'success');
}

function selectProduct(id) {
    document.getElementById('product-search-results').classList.add('hidden');
    window.vegeOrderApp.showNotification('Product selected', 'success');
}

// Initialize App when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.vegeOrderApp = new VegeOrderApp();
    
    window.vegeOrderApp.analytics.setApp(window.vegeOrderApp);
    
    setInterval(() => {
        window.vegeOrderApp.updateStatusBar();
    }, 60000);
});

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}
