// ========================================
// MISSING FUNCTIONS FOR VEGEORDER PRO
// Add these functions to your existing script
// ========================================

// Global variables for slot selection
let selectedAddonQuantity = 0;
let selectedAddonPrice = 0;

// Close upgrade dialog
function closeUpgradeDialog() {
    const modal = document.getElementById('upgrade-modal');
    if (modal) {
        modal.remove();
    }
}

// Select addon slots (predefined quantities)
function selectAddonSlots(quantity) {
    selectedAddonQuantity = quantity;
    selectedAddonPrice = app.calculateSlotPrice(quantity, 'addon');
    
    // Clear previous selections
    document.querySelectorAll('.addon-selection button').forEach(btn => {
        btn.style.background = '';
    });
    
    // Highlight selected button
    event.target.style.background = 'linear-gradient(135deg, #22d3ee, #0891b2)';
    
    // Show selection summary
    const selectionDiv = document.getElementById('addon-selection');
    if (selectionDiv) {
        selectionDiv.style.display = 'block';
        document.getElementById('selected-quantity').textContent = `${quantity} slots`;
        document.getElementById('selected-price').textContent = `RM ${selectedAddonPrice.toFixed(2)}`;
    }
    
    app.showNotification(`üí° Selected ${quantity} slots for RM ${selectedAddonPrice.toFixed(2)}`, 'info');
}

// Select custom slots
function selectCustomSlots() {
    const customInput = document.getElementById('custom-slots');
    const quantity = parseInt(customInput.value);
    
    if (!quantity || quantity < 1) {
        app.showNotification('‚ùå Please enter a valid quantity (minimum 1)', 'error');
        return;
    }
    
    if (quantity > 10000) {
        app.showNotification('‚ùå Maximum 10,000 slots per purchase', 'error');
        return;
    }
    
    selectedAddonQuantity = quantity;
    selectedAddonPrice = app.calculateSlotPrice(quantity, 'addon');
    
    // Show selection summary
    const selectionDiv = document.getElementById('addon-selection');
    if (selectionDiv) {
        selectionDiv.style.display = 'block';
        document.getElementById('selected-quantity').textContent = `${quantity} slots`;
        document.getElementById('selected-price').textContent = `RM ${selectedAddonPrice.toFixed(2)}`;
    }
    
    app.showNotification(`üí° Selected ${quantity} custom slots for RM ${selectedAddonPrice.toFixed(2)}`, 'info');
}

// Purchase addon slots
function purchaseAddonSlots() {
    if (selectedAddonQuantity <= 0) {
        app.showNotification('‚ùå No slots selected for purchase', 'error');
        return;
    }
    
    const confirmMessage = `Purchase ${selectedAddonQuantity} add-on slots for RM ${selectedAddonPrice.toFixed(2)}?`;
    
    if (confirm(confirmMessage)) {
        // Simulate payment processing
        app.showNotification('üí≥ Processing payment...', 'info');
        
        setTimeout(() => {
            const success = app.addCustomerSlots(selectedAddonQuantity, 'addon');
            
            if (success) {
                // Close upgrade dialog
                closeUpgradeDialog();
                
                // Reset selection
                selectedAddonQuantity = 0;
                selectedAddonPrice = 0;
                
                app.showNotification(`üéâ Successfully purchased ${selectedAddonQuantity} customer slots!`, 'success');
            } else {
                app.showNotification('‚ùå Purchase failed. Please try again.', 'error');
            }
        }, 2000);
    }
}

// Purchase premium plan
function purchasePremiumPlan() {
    const confirmMessage = 'Upgrade to Premium Plan for RM 99.00?\n\n‚úÖ 100 customer slots\n‚úÖ Advanced analytics\n‚úÖ Priority support\n‚úÖ Export features\n‚úÖ Bulk operations';
    
    if (confirm(confirmMessage)) {
        app.showNotification('üí≥ Processing premium upgrade...', 'info');
        
        setTimeout(() => {
            const success = app.upgradeToPremium();
            
            if (success) {
                closeUpgradeDialog();
                app.showNotification('üéâ Welcome to Premium! Enjoy your enhanced features.', 'success');
            } else {
                app.showNotification('‚ùå Upgrade failed. Please try again.', 'error');
            }
        }, 2000);
    }
}

// Allocate exactly 200 customer slots (direct function)
function allocate200CustomerSlots() {
    const confirmMessage = 'Allocate 200 add-on customer slots for RM 400.00?\n\nThis will immediately add 200 slots to your account.';
    
    if (confirm(confirmMessage)) {
        app.showNotification('üéØ Allocating 200 customer slots...', 'info');
        
        setTimeout(() => {
            app.showNotification('üí≥ Processing payment for 200 slots...', 'info');
            
            setTimeout(() => {
                const success = app.addCustomerSlots(200, 'addon');
                
                if (success) {
                    app.showNotification('üöÄ 200 customer slots allocated successfully!', 'success');
                    app.showNotification(`üìà Total capacity: ${app.customerSlots.total} customers`, 'success');
                    
                    // Update the header stats
                    setTimeout(() => {
                        app.updateStats();
                        app.renderViews();
                    }, 500);
                    
                    // Show celebration
                    showSlotAllocationCelebration(200);
                } else {
                    app.showNotification('‚ùå Slot allocation failed. Please try again.', 'error');
                }
            }, 1500);
        }, 1000);
    }
}

// Show celebration animation for slot allocation
function showSlotAllocationCelebration(slotsAdded) {
    // Create celebration modal
    const celebrationModal = document.createElement('div');
    celebrationModal.className = 'modal show';
    celebrationModal.style.background = 'rgba(0,0,0,0.8)';
    celebrationModal.innerHTML = `
        <div class="modal-content" style="text-align: center; max-width: 400px; margin: auto;">
            <div style="font-size: 80px; margin: 20px 0;">üéâ</div>
            <h2 style="color: #22c55e; margin-bottom: 16px;">Success!</h2>
            <div style="font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">
                +${slotsAdded} Customer Slots
            </div>
            <div style="color: #6b7280; margin-bottom: 20px;">
                Your business can now grow without limits!
            </div>
            <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 16px; padding: 20px; margin: 20px 0; border: 2px solid #0891b2;">
                <div style="color: #0c4a6e; font-weight: 600;">New Total Capacity:</div>
                <div style="font-size: 32px; font-weight: 800; color: #0891b2;">${app.customerSlots.total} Customers</div>
            </div>
            <button onclick="closeCelebrationModal()" class="btn btn-primary" style="width: 100%;">
                üöÄ Continue Growing!
            </button>
        </div>
    `;
    
    document.body.appendChild(celebrationModal);
    
    // Auto-close after 5 seconds
    setTimeout(() => {
        if (document.body.contains(celebrationModal)) {
            celebrationModal.remove();
        }
    }, 5000);
}

// Close celebration modal
function closeCelebrationModal() {
    const modal = document.querySelector('.modal');
    if (modal) {
        modal.remove();
    }
}

// Enhanced version of the existing addCustomerSlots method
// Add this to the VegeOrderApp class or update the existing method
function enhanceCustomerSlotMethods() {
    // Enhance the existing app instance
    if (typeof app !== 'undefined') {
        
        // Override the calculateSlotPrice method for better pricing
        app.calculateSlotPrice = function(quantity, plan) {
            const prices = {
                addon: 2.00, // RM 2.00 per slot for addon
                premium: 99.00, // RM 99.00 flat for premium plan
                enterprise: 1.00 // RM 1.00 per slot for enterprise
            };
            
            if (plan === 'premium') {
                return prices.premium;
            }
            
            // Volume discounts for large purchases
            if (plan === 'addon' && quantity >= 500) {
                return quantity * 1.50; // RM 1.50 per slot for 500+
            } else if (plan === 'addon' && quantity >= 200) {
                return quantity * 1.75; // RM 1.75 per slot for 200+
            } else if (plan === 'addon' && quantity >= 100) {
                return quantity * 1.90; // RM 1.90 per slot for 100+
            }
            
            return quantity * (prices[plan] || prices.addon);
        };
        
        // Enhanced notification for slot allocation
        app.showSlotAllocationNotification = function(quantity, price) {
            const notification = document.createElement('div');
            notification.className = 'notification success show';
            notification.style.cssText = `
                position: fixed;
                top: calc(env(safe-area-inset-top, 44px) + 80px);
                left: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 20px;
                border-radius: 16px;
                font-weight: 600;
                box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
                z-index: 250;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideDown 0.3s ease;
            `;
            
            notification.innerHTML = `
                <span style="font-size: 24px;">üéâ</span>
                <div>
                    <div style="font-weight: 700; margin-bottom: 4px;">
                        ${quantity} Slots Added Successfully!
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        Total: ${this.customerSlots.total} slots ‚Ä¢ Cost: RM ${price.toFixed(2)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        };
    }
}

// Initialize enhanced methods when the app is ready
if (typeof app !== 'undefined') {
    enhanceCustomerSlotMethods();
} else {
    // Wait for app to be initialized
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(enhanceCustomerSlotMethods, 100);
    });
}

// Quick action: Allocate 200 slots immediately
function quickAllocate200Slots() {
    if (typeof app === 'undefined') {
        console.error('App not initialized yet');
        return;
    }
    
    console.log('üéØ Starting 200-slot allocation process...');
    
    // Show confirmation with detailed breakdown
    const confirmMessage = `üöÄ ALLOCATE 200 CUSTOMER SLOTS
    
üìä Current Status:
‚Ä¢ Current: ${app.customerSlots.used}/${app.customerSlots.total} slots
‚Ä¢ Plan: ${app.customerSlots.plan.toUpperCase()}

üí∞ Purchase Details:
‚Ä¢ Quantity: 200 slots
‚Ä¢ Price: RM ${app.calculateSlotPrice(200, 'addon').toFixed(2)}
‚Ä¢ Rate: RM ${(app.calculateSlotPrice(200, 'addon') / 200).toFixed(2)} per slot

‚úÖ After Purchase:
‚Ä¢ Total Capacity: ${app.customerSlots.total + 200} customers
‚Ä¢ Available: ${app.customerSlots.remaining + 200} new slots

Proceed with allocation?`;

    if (confirm(confirmMessage)) {
        // Execute allocation
        allocate200CustomerSlots();
    } else {
        app.showNotification('‚ùå 200-slot allocation cancelled', 'warning');
    }
}

// Export allocation summary
function exportSlotAllocationSummary() {
    if (typeof app === 'undefined') return;
    
    const summary = {
        timestamp: new Date().toISOString(),
        currentStatus: {
            totalSlots: app.customerSlots.total,
            usedSlots: app.customerSlots.used,
            remainingSlots: app.customerSlots.remaining,
            plan: app.customerSlots.plan,
            addonSlots: app.customerSlots.addonSlots
        },
        upgradeHistory: app.customerSlots.upgradeHistory,
        recommendations: {
            canAddCustomers: app.customerSlots.remaining,
            suggestedUpgrade: app.customerSlots.remaining < 10 ? 'Consider adding more slots' : 'Current capacity sufficient'
        }
    };
    
    // Create downloadable JSON
    const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vegeorder-slots-summary-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    app.showNotification('üìä Slot summary exported successfully!', 'success');
}

// Console command for quick 200-slot allocation
console.log(`
ü•¨ VEGEORDER PRO - CUSTOMER SLOT COMMANDS

Quick Commands:
‚Ä¢ quickAllocate200Slots() - Allocate 200 slots immediately
‚Ä¢ allocate200CustomerSlots() - Full allocation process with confirmation
‚Ä¢ exportSlotAllocationSummary() - Export current slot status

Current Status: ${typeof app !== 'undefined' ? app.customerSlots?.used || 0 : 0}/${typeof app !== 'undefined' ? app.customerSlots?.total || 10 : 10} slots used
`);

// Auto-execute 200 slot allocation after page load (commented out for safety)
/*
setTimeout(() => {
    if (typeof app !== 'undefined' && app.customerSlots.total < 100) {
        console.log('üöÄ Auto-allocating 200 customer slots...');
        quickAllocate200Slots();
    }
}, 5000);
*/
