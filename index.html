// ========================================
// VEGEORDER PRO - COMPLETE CUSTOMER SLOT INTEGRATION
// Add this script to your main VegeOrder Pro index.html
// ========================================

// Global variables for slot management
let selectedAddonQuantity = 0;
let selectedAddonPrice = 0;
let currentSlotSelection = null;

// Enhanced Customer Slot Methods - Add to VegeOrderApp class
function enhanceVegeOrderWithSlots() {
    if (typeof app === 'undefined') {
        console.log('Waiting for app to initialize...');
        setTimeout(enhanceVegeOrderWithSlots, 100);
        return;
    }
    
    // Enhanced calculateSlotPrice with volume discounts
    app.calculateSlotPrice = function(quantity, plan) {
        const basePrices = {
            addon: 2.00,
            premium: 99.00,
            enterprise: 1.00
        };
        
        if (plan === 'premium') {
            return basePrices.premium;
        }
        
        // Volume discount tiers
        let pricePerSlot = basePrices[plan] || basePrices.addon;
        
        if (quantity >= 1000) {
            pricePerSlot = 1.25; // Best rate for 1000+ slots
        } else if (quantity >= 500) {
            pricePerSlot = 1.50; // Better rate for 500+ slots  
        } else if (quantity >= 200) {
            pricePerSlot = 1.75; // Good rate for 200+ slots
        } else if (quantity >= 100) {
            pricePerSlot = 1.90; // Small discount for 100+ slots
        }
        
        return quantity * pricePerSlot;
    };
    
    // Enhanced addCustomerSlots with better feedback
    const originalAddSlots = app.addCustomerSlots;
    app.addCustomerSlots = function(quantity, plan = 'addon') {
        const price = this.calculateSlotPrice(quantity, plan);
        
        const upgrade = {
            id: Date.now(),
            date: new Date().toISOString(),
            plan: plan,
            slotsAdded: quantity,
            price: price,
            paymentMethod: 'simulated'
        };
        
        this.customerSlots.total += quantity;
        if (plan === 'addon') {
            this.customerSlots.addonSlots += quantity;
        } else if (plan === 'premium') {
            this.customerSlots.plan = 'premium';
        }
        
        this.customerSlots.remaining = this.customerSlots.total - this.customerSlots.used;
        this.customerSlots.lastUpgrade = new Date().toISOString();
        this.customerSlots.upgradeHistory.push(upgrade);
        
        this.updateCustomerSlotUsage();
        this.saveDataToStorage();
        this.updateStats();
        
        // Enhanced notification
        this.showSlotAllocationSuccess(quantity, price, plan);
        
        // Update UI
        setTimeout(() => {
            this.updateStats();
            this.renderViews();
        }, 500);
        
        return true;
    };
    
    // New method: Show slot allocation success
    app.showSlotAllocationSuccess = function(quantity, price, plan) {
        // Create enhanced notification
        const notification = document.createElement('div');
        notification.className = 'notification success show';
        notification.style.cssText = `
            position: fixed;
            top: calc(env(safe-area-inset-top, 44px) + 80px);
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 16px;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
            z-index: 250;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s ease;
            backdrop-filter: blur(20px);
        `;
        
        const planIcon = plan === 'premium' ? 'üíé' : 'üì¶';
        const planText = plan === 'premium' ? 'Premium Upgrade' : 'Slots Added';
        
        notification.innerHTML = `
            <span style="font-size: 28px;">${planIcon}</span>
            <div style="flex: 1;">
                <div style="font-weight: 800; margin-bottom: 4px; font-size: 16px;">
                    +${quantity.toLocaleString()} ${planText}!
                </div>
                <div style="font-size: 14px; opacity: 0.9;">
                    Total: ${this.customerSlots.total.toLocaleString()} slots ‚Ä¢ Cost: RM ${price.toFixed(2)}
                </div>
            </div>
            <button onclick="this.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 16px; cursor: pointer; font-size: 16px;">‚úï</button>
        `;
        
        document.body.appendChild(notification);
        
        // Haptic feedback
        if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
        }
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (document.body.contains(notification)) {
                notification.remove();
            }
        }, 5000);
    };
    
    // Enhanced customer slot validation
    app.canAddCustomerEnhanced = function() {
        if (this.customerSlots.remaining > 0) {
            return { canAdd: true, reason: null };
        }
        
        const suggestions = [];
        if (this.customerSlots.plan === 'free') {
            suggestions.push('Upgrade to Premium (100 slots) for RM 99');
        }
        suggestions.push(`Add 200 slots for RM ${this.calculateSlotPrice(200, 'addon').toFixed(2)}`);
        suggestions.push('Add custom quantity at RM 2.00 per slot');
        
        return {
            canAdd: false,
            reason: 'Customer slot limit reached',
            suggestions: suggestions
        };
    };
    
    console.log('‚úÖ VegeOrder Pro enhanced with advanced slot management');
}

// Enhanced Upgrade Dialog with Mobile Design
function showEnhancedUpgradeDialog() {
    const upgradeModal = document.createElement('div');
    upgradeModal.className = 'modal show';
    upgradeModal.id = 'upgrade-modal';
    upgradeModal.innerHTML = `
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 style="display: flex; align-items: center; gap: 8px;">üöÄ Upgrade Customer Capacity</h3>
                <button class="close-btn" onclick="closeUpgradeDialog()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Current Status -->
                <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 2px solid #d1d5db;">
                    <h4 style="color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        üìä Current Status
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: 800; color: #ef4444;">${app.customerSlots.used}</div>
                            <div style="font-size: 12px; color: #6b7280;">USED</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 800; color: #f59e0b;">${app.customerSlots.remaining}</div>
                            <div style="font-size: 12px; color: #6b7280;">REMAINING</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 800; color: #3b82f6;">${app.customerSlots.total}</div>
                            <div style="font-size: 12px; color: #6b7280;">TOTAL</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; text-align: center;">
                        <span style="background: ${app.customerSlots.plan === 'premium' ? '#7c3aed' : '#6b7280'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                            ${app.customerSlots.plan} Plan
                        </span>
                    </div>
                </div>
                
                <!-- Quick Action: 200 Slots -->
                <div style="background: linear-gradient(135deg, #ecfeff, #cffafe); border: 2px solid #22d3ee; border-radius: 16px; padding: 20px; margin-bottom: 20px; position: relative;">
                    <div style="position: absolute; top: -8px; right: 12px; background: #f59e0b; color: white; font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 8px;">
                        ‚≠ê RECOMMENDED
                    </div>
                    <h4 style="color: #0c4a6e; margin-bottom: 12px; font-size: 18px;">üéØ Quick Allocation</h4>
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 36px; font-weight: 800; color: #0891b2; margin-bottom: 8px;">200 Slots</div>
                        <div style="font-size: 24px; font-weight: 700; color: #0c4a6e; margin-bottom: 4px;">RM ${app.calculateSlotPrice(200, 'addon').toFixed(2)}</div>
                        <div style="color: #0369a1; font-size: 14px;">RM ${(app.calculateSlotPrice(200, 'addon') / 200).toFixed(2)} per slot</div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; font-size: 16px; font-weight: 700;" onclick="purchaseQuick200Slots()">
                        üöÄ Allocate 200 Slots Now
                    </button>
                </div>
                
                <!-- Premium Plan -->
                ${app.customerSlots.plan !== 'premium' ? `
                <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border: 2px solid #8b5cf6; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #581c87; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        üíé Premium Plan Upgrade
                    </h4>
                    <div style="color: #581c87; font-size: 28px; font-weight: 800; margin-bottom: 8px;">RM 99.00</div>
                    <div style="color: #7c3aed; margin-bottom: 16px; font-weight: 600;">100 Customer Slots + Premium Features</div>
                    <ul style="color: #7c3aed; font-size: 14px; margin-bottom: 16px; padding-left: 20px; line-height: 1.6;">
                        <li>Advanced analytics dashboard</li>
                        <li>Priority customer support</li>
                        <li>Data export features</li>
                        <li>Bulk operations</li>
                        <li>Custom branding options</li>
                    </ul>
                    <button class="btn btn-purple" style="width: 100%; font-weight: 700;" onclick="purchasePremiumPlan()">
                        üíé Upgrade to Premium
                    </button>
                </div>
                ` : ''}
                
                <!-- Add-on Packages -->
                <div style="background: linear-gradient(135deg, #f9fafb, #f3f4f6); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #d1d5db;">
                    <h4 style="color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        üì¶ Add-on Packages
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="addon-package" onclick="selectAddonPackage(50)" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                            <div style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 4px;">50</div>
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">slots</div>
                            <div style="font-size: 16px; font-weight: 600; color: #059669;">RM 100</div>
                        </div>
                        <div class="addon-package" onclick="selectAddonPackage(100)" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                            <div style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 4px;">100</div>
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">slots</div>
                            <div style="font-size: 16px; font-weight: 600; color: #059669;">RM 200</div>
                        </div>
                        <div class="addon-package" onclick="selectAddonPackage(500)" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                            <div style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 4px;">500</div>
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">slots</div>
                            <div style="font-size: 16px; font-weight: 600; color: #059669;">RM 750</div>
                            <div style="font-size: 10px; color: #f59e0b; font-weight: 700; margin-top: 4px;">SAVE 25%</div>
                        </div>
                        <div class="addon-package" onclick="selectAddonPackage(1000)" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                            <div style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 4px;">1000</div>
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">slots</div>
                            <div style="font-size: 16px; font-weight: 600; color: #059669;">RM 1250</div>
                            <div style="font-size: 10px; color: #f59e0b; font-weight: 700; margin-top: 4px;">SAVE 37%</div>
                        </div>
                    </div>
                    
                    <!-- Custom Quantity -->
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 16px;">
                        <h5 style="color: #374151; margin-bottom: 12px; font-weight: 600;">Custom Quantity</h5>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" placeholder="Enter quantity" id="custom-slots-input" 
                                   style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px;"
                                   min="1" max="10000">
                            <button class="btn btn-gray" onclick="selectCustomSlots()" style="padding: 12px 16px; font-size: 14px; min-height: auto;">
                                Calculate
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Selection Summary -->
                <div id="addon-selection-summary" style="display: none; background: linear-gradient(135deg, #ecfeff, #cffafe); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 2px solid #22d3ee;">
                    <h4 style="color: #0c4a6e; margin-bottom: 12px;">üìã Purchase Summary</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #0369a1; font-weight: 600;">Selected Quantity:</span>
                        <span id="summary-quantity" style="color: #0c4a6e; font-weight: 800;">0 slots</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <span style="color: #0369a1; font-weight: 600;">Total Price:</span>
                        <span id="summary-price" style="color: #0c4a6e; font-weight: 800; font-size: 18px;">RM 0.00</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <button class="btn btn-success" onclick="purchaseSelectedAddon()" style="font-weight: 700;">
                            üí≥ Purchase Now
                        </button>
                        <button class="btn btn-gray" onclick="clearAddonSelection()" style="font-weight: 700;">
                            ‚ùå Clear
                        </button>
                    </div>
                </div>
                
                <!-- Security Notice -->
                <div style="text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <div style="font-size: 20px; margin-bottom: 8px;">üîí</div>
                    <div style="color: #6b7280; font-size: 14px; margin: 0; font-weight: 500;">
                        <strong>Secure Payment:</strong> All transactions are processed securely. 
                        Instant activation upon payment confirmation.
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(upgradeModal);
    
    // Add click handlers for addon packages
    document.querySelectorAll('.addon-package').forEach(el => {
        el.addEventListener('mouseenter', function() {
            this.style.borderColor = '#22d3ee';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 24px rgba(34, 211, 238, 0.2)';
        });
        
        el.addEventListener('mouseleave', function() {
            if (!this.classList.contains('selected')) {
                this.style.borderColor = '#e5e7eb';
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            }
        });
    });
}

// Addon package selection
function selectAddonPackage(quantity) {
    // Clear previous selections
    document.querySelectorAll('.addon-package').forEach(el => {
        el.classList.remove('selected');
        el.style.borderColor = '#e5e7eb';
        el.style.backgroundColor = 'white';
    });
    
    // Select current package
    event.target.closest('.addon-package').classList.add('selected');
    event.target.closest('.addon-package').style.borderColor = '#22d3ee';
    event.target.closest('.addon-package').style.backgroundColor = '#f0f9ff';
    
    selectedAddonQuantity = quantity;
    selectedAddonPrice = app.calculateSlotPrice(quantity, 'addon');
    
    updateAddonSelectionSummary();
    
    // Haptic feedback
    if (navigator.vibrate) {
        navigator.vibrate(10);
    }
}

// Custom slots selection
function selectCustomSlots() {
    const input = document.getElementById('custom-slots-input');
    const quantity = parseInt(input.value);
    
    if (!quantity || quantity < 1) {
        app.showNotification('‚ùå Please enter a valid quantity (minimum 1)', 'error');
        return;
    }
    
    if (quantity > 10000) {
        app.showNotification('‚ùå Maximum 10,000 slots per purchase', 'error');
        return;
    }
    
    // Clear package selections
    document.querySelectorAll('.addon-package').forEach(el => {
        el.classList.remove('selected');
        el.style.borderColor = '#e5e7eb';
        el.style.backgroundColor = 'white';
    });
    
    selectedAddonQuantity = quantity;
    selectedAddonPrice = app.calculateSlotPrice(quantity, 'addon');
    
    updateAddonSelectionSummary();
    
    app.showNotification(`üí° Selected ${quantity.toLocaleString()} custom slots`, 'info');
}

// Update addon selection summary
function updateAddonSelectionSummary() {
    const summaryDiv = document.getElementById('addon-selection-summary');
    
    if (selectedAddonQuantity > 0) {
        summaryDiv.style.display = 'block';
        document.getElementById('summary-quantity').textContent = `${selectedAddonQuantity.toLocaleString()} slots`;
        document.getElementById('summary-price').textContent = `RM ${selectedAddonPrice.toFixed(2)}`;
    } else {
        summaryDiv.style.display = 'none';
    }
}

// Clear addon selection
function clearAddonSelection() {
    selectedAddonQuantity = 0;
    selectedAddonPrice = 0;
    
    document.querySelectorAll('.addon-package').forEach(el => {
        el.classList.remove('selected');
        el.style.borderColor = '#e5e7eb';
        el.style.backgroundColor = 'white';
    });
    
    document.getElementById('custom-slots-input').value = '';
    updateAddonSelectionSummary();
    
    app.showNotification('üóëÔ∏è Selection cleared', 'info');
}

// Purchase functions
function purchaseQuick200Slots() {
    const price = app.calculateSlotPrice(200, 'addon');
    const confirmMessage = `üéØ ALLOCATE 200 CUSTOMER SLOTS

üí∞ Purchase Details:
‚Ä¢ Quantity: 200 slots
‚Ä¢ Price: RM ${price.toFixed(2)}
‚Ä¢ Rate: RM ${(price / 200).toFixed(2)} per slot

‚úÖ After Purchase:
‚Ä¢ New Total: ${app.customerSlots.total + 200} customers
‚Ä¢ Available: ${app.customerSlots.remaining + 200} new slots

Proceed with allocation?`;
    
    if (confirm(confirmMessage)) {
        closeUpgradeDialog();
        simulatePurchaseProcess(200, 'addon');
    }
}

function purchasePremiumPlan() {
    const confirmMessage = `üíé UPGRADE TO PREMIUM PLAN

üí∞ Investment: RM 99.00
üì¶ Includes: 100 customer slots + Premium features

‚ú® Premium Features:
‚Ä¢ Advanced analytics dashboard
‚Ä¢ Priority customer support  
‚Ä¢ Data export capabilities
‚Ä¢ Bulk operations
‚Ä¢ Custom branding options

Your current add-on slots will be preserved.

Proceed with Premium upgrade?`;
    
    if (confirm(confirmMessage)) {
        closeUpgradeDialog();
        simulatePurchaseProcess(100, 'premium');
    }
}

function purchaseSelectedAddon() {
    if (selectedAddonQuantity <= 0) {
        app.showNotification('‚ùå No slots selected for purchase', 'error');
        return;
    }
    
    const confirmMessage = `Purchase ${selectedAddonQuantity.toLocaleString()} add-on slots for RM ${selectedAddonPrice.toFixed(2)}?`;
    
    if (confirm(confirmMessage)) {
        closeUpgradeDialog();
        simulatePurchaseProcess(selectedAddonQuantity, 'addon');
        clearAddonSelection();
    }
}

// Simulate purchase process with realistic timing
function simulatePurchaseProcess(quantity, plan) {
    const planText = plan === 'premium' ? 'Premium upgrade' : `${quantity.toLocaleString()} slots`;
    
    app.showNotification('üí≥ Processing payment...', 'info');
    
    setTimeout(() => {
        app.showNotification('üîê Verifying transaction...', 'info');
        
        setTimeout(() => {
            app.showNotification('‚úÖ Payment confirmed!', 'success');
            
            setTimeout(() => {
                app.showNotification(`üì¶ Allocating ${planText}...`, 'info');
                
                setTimeout(() => {
                    const success = app.addCustomerSlots(quantity, plan);
                    
                    if (success) {
                        showCelebrationModal(quantity, plan);
                    }
                }, 1000);
            }, 1000);
        }, 1500);
    }, 1000);
}

// Enhanced celebration modal
function showCelebrationModal(quantity, plan) {
    const isPlans = plan === 'premium';
    const icon = isPremium ? 'üíé' : 'üéâ';
    const title = isPremium ? 'Premium Activated!' : 'Slots Allocated!';
    const message = isPremium ? 'Welcome to Premium!' : `+${quantity.toLocaleString()} Customer Slots`;
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.background = 'rgba(0,0,0,0.8)';
    modal.innerHTML = `
        <div class="modal-content" style="text-align: center; max-width: 400px; margin: auto; background: linear-gradient(135deg, #f9fafb, #f3f4f6); color: #1f2937;">
            <div style="font-size: 80px; margin: 20px 0; animation: bounce 1s ease-in-out infinite;">${icon}</div>
            <h2 style="color: #22c55e; margin-bottom: 16px; font-weight: 800;">${title}</h2>
            <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">
                ${message}
            </div>
            <div style="color: #6b7280; margin-bottom: 24px;">
                Your business can now grow without limits!
            </div>
            
            <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 16px; padding: 20px; margin: 20px 0; border: 2px solid #0891b2;">
                <div style="color: #0c4a6e; font-weight: 600; margin-bottom: 8px;">New Total Capacity:</div>
                <div style="font-size: 36px; font-weight: 800; color: #0891b2; margin-bottom: 4px;">
                    ${app.customerSlots.total.toLocaleString()}
                </div>
                <div style="color: #0c4a6e; font-size: 14px;">Customer Slots Available</div>
            </div>
            
            ${isPremium ? `
            <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 16px; padding: 16px; margin: 16px 0; border: 2px solid #8b5cf6;">
                <div style="color: #581c87; font-weight: 600; margin-bottom: 8px;">üéÅ Premium Features Unlocked:</div>
                <div style="color: #7c3aed; font-size: 13px; line-height: 1.5;">
                    Advanced Analytics ‚Ä¢ Priority Support ‚Ä¢ Export Tools ‚Ä¢ Bulk Operations ‚Ä¢ Custom Branding
                </div>
            </div>
            ` : ''}
            
            <button onclick="closeCelebrationModal()" class="btn btn-primary" style="width: 100%; font-weight: 700; color: white;">
                üöÄ Continue Growing Your Business!
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Haptic celebration
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200]);
    }
    
    // Auto-close after 10 seconds
    setTimeout(() => {
        if (document.body.contains(modal)) {
            modal.remove();
        }
    }, 10000);
}

// Close functions
function closeUpgradeDialog() {
    const modal = document.getElementById('upgrade-modal');
    if (modal) {
        modal.remove();
    }
    clearAddonSelection();
}

function closeCelebrationModal() {
    const modal = document.querySelector('.modal');
    if (modal && modal.style.background === 'rgba(0, 0, 0, 0.8)') {
        modal.remove();
    }
}

// Enhanced customer addition with slot checking
function addCustomerWithSlotCheck() {
    const canAdd = app.canAddCustomerEnhanced();
    
    if (canAdd.canAdd) {
        app.openCustomerForm();
    } else {
        app.showNotification(canAdd.reason, 'warning');
        setTimeout(() => {
            showEnhancedUpgradeDialog();
        }, 1000);
    }
}

// Override the original openCustomerForm to include slot checking
const originalOpenCustomerForm = window.openCustomerForm;
window.openCustomerForm = function() {
    if (app && !app.canAddCustomer()) {
        addCustomerWithSlotCheck();
    } else {
        originalOpenCustomerForm();
    }
};

// Quick allocation functions for console/direct access
function allocate200CustomerSlots() {
    if (typeof app === 'undefined') {
        console.error('VegeOrder app not initialized');
        return;
    }
    
    purchaseQuick200Slots();
}

function quickUpgradeToPremium() {
    if (typeof app === 'undefined') {
        console.error('VegeOrder app not initialized');
        return;
    }
    
    if (app.customerSlots.plan === 'premium') {
        app.showNotification('‚ö†Ô∏è Already on Premium plan', 'warning');
        return;
    }
    
    purchasePremiumPlan();
}

// Add CSS animations for celebration
const celebrationCSS = `
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    
    @keyframes slideDown {
        from { transform: translateY(-100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .addon-package:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 24px rgba(34, 211, 238, 0.2) !important;
    }
    
    .addon-package.selected {
        border-color: #22d3ee !important;
        background-color: #f0f9ff !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 24px rgba(34, 211, 238, 0.3) !important;
    }
`;

// Inject CSS
const styleSheet = document.createElement('style');
styleSheet.textContent = celebrationCSS;
document.head.appendChild(styleSheet);

// Console commands and initialization
document.addEventListener('DOMContentLoaded', () => {
    // Wait for app initialization
    setTimeout(() => {
        enhanceVegeOrderWithSlots();
        
        console.log(`
ü•¨ VEGEORDER PRO - ENHANCED CUSTOMER SLOT SYSTEM

üöÄ Quick Commands:
‚Ä¢ allocate200CustomerSlots() - Allocate 200 slots directly
‚Ä¢ quickUpgradeToPremium() - Upgrade to Premium plan
‚Ä¢ showEnhancedUpgradeDialog() - Show upgrade options
‚Ä¢ app.customerSlots - View current slot status

üìä Current Status: 
‚Ä¢ Slots: ${typeof app !== 'undefined' ? app.customerSlots?.used || 0 : 0}/${typeof app !== 'undefined' ? app.customerSlots?.total || 10 : 10} used
‚Ä¢ Plan: ${typeof app !== 'undefined' ? app.customerSlots?.plan?.toUpperCase() || 'FREE' : 'FREE'}
‚Ä¢ Remaining: ${typeof app !== 'undefined' ? app.customerSlots?.remaining || 0 : 0} slots available

Ready for unlimited growth! üöÄ
        `);
    }, 500);
});

// Auto-demo (uncomment to enable automatic 200-slot allocation after 5 seconds)
/*
setTimeout(() => {
    if (typeof app !== 'undefined' && app.customerSlots.remaining <= 2) {
        if (confirm('üöÄ Demo: Would you like to allocate 200 customer slots automatically?')) {
            allocate200CustomerSlots();
        }
    }
}, 5000);
*/

// Export for global access
window.allocate200CustomerSlots = allocate200CustomerSlots;
window.quickUpgradeToPremium = quickUpgradeToPremium;
window.showEnhancedUpgradeDialog = showEnhancedUpgradeDialog;
